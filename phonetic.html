<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注音符號拼讀點選遊戲</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用教育部推薦的字體 (如: Inter)，並增加注音符號的辨識度 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* 點選元件樣式 */
        .click-tile {
            cursor: pointer;
            user-select: none;
            transition: transform 0.15s ease-out, background-color 0.15s ease-out, opacity 0.3s;
            border: 2px solid transparent;
        }
        .click-tile:hover {
            transform: scale(1.05);
            background-color: #fcd34d; /* 淺黃色 */
        }
        .click-tile.selected {
            opacity: 0.3; /* 選中後變淡，表示已被使用 */
            pointer-events: none; /* 禁用點擊 */
        }
        /* 放置區樣式 */
        .drop-zone {
            border: 3px dashed #9ca3af; /* 灰色虛線 */
            transition: background-color 0.2s;
            cursor: pointer; /* 點擊可移除 */
        }
        .drop-zone:hover:not(.completed-answer) {
            background-color: #fef3c7; /* 淺黃色提示可點擊 */
        }
        .drop-zone.completed-answer {
            background-color: #3b82f6; /* 藍色背景 (已填入) */
            color: #ffffff;
            border-style: solid;
            border-color: #2563eb;
        }
        /* 調整國字提示字體大小以容納二字詞 */
        #chinese-hint {
            font-size: clamp(3rem, 10vw, 5rem); /* RWD 字體大小 */
        }
        /* Pinyin Group wrapper for consistent spacing */
        .pinyin-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem; /* Space between initial, final, tone */
        }
        /* 調整放置區大小 */
        .drop-zone[data-type="tone"] {
            width: 4rem; 
            height: 4rem; 
            font-size: 1.875rem; 
        }
        .drop-zone[data-type="initial"], 
        .drop-zone[data-type="final"] {
            width: 6rem; 
            height: 6rem; 
            font-size: 2.25rem; 
        }
        @media (min-width: 640px) {
            .drop-zone[data-type="tone"] {
                width: 5rem; 
                height: 5rem; 
                font-size: 3rem; 
            }
            .drop-zone[data-type="initial"], 
            .drop-zone[data-type="final"] {
                width: 8rem; 
                height: 8rem; 
                font-size: 3.75rem; 
            }
        }
    </style>
</head>

<body class="p-4 sm:p-8">

    <div id="game-container" class="w-full max-w-5xl bg-white shadow-2xl rounded-xl p-6 sm:p-10 border-4 border-yellow-400">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-center text-red-600 mb-6 tracking-wide">
            注音符號點選拼讀
        </h1>

        <!-- 遊戲資訊：計時器與分數 -->
        <div class="flex justify-between items-center mb-8 border-b-2 pb-4">
            <div class="text-xl sm:text-2xl font-bold text-gray-700">
                計時器: <span id="timer" class="text-red-500 text-3xl sm:text-4xl ml-2">3:00</span>
            </div>
            <div class="text-xl sm:text-2xl font-bold text-gray-700">
                分數: <span id="score" class="text-blue-500 text-3xl sm:text-4xl ml-2">0</span>
            </div>
        </div>

        <!-- 遊戲區塊 -->
        <div id="game-area">
            <!-- 題目區塊 -->
            <div class="mb-8 text-center bg-yellow-100 p-4 rounded-lg shadow-inner">
                
                <!-- 國字提示區塊 + 語音按鈕 -->
                <div class="flex flex-col items-center justify-center mb-6">
                    <div id="chinese-hint" class="font-extrabold text-red-700 p-4 bg-white rounded-xl shadow-lg mb-4">
                        <!-- 國字會在這裡顯示 -->
                    </div>
                    <!-- 語音播放按鈕 -->
                    <button id="speak-button" class="bg-red-500 text-white p-4 rounded-full shadow-xl hover:bg-red-600 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <!-- Speaker Icon -->
                        <svg id="speaker-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                        </svg>
                        <!-- Loading Spinner -->
                        <div id="loading-spinner" class="hidden h-6 w-6 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                    </button>
                    <p class="text-sm mt-2 text-red-500 font-semibold">（點擊上方按鈕聽**目標發音**）</p>
                </div>
                
                <p class="text-2xl sm:text-3xl font-semibold text-gray-800 mb-3">點擊注音符號，將它填入正確位置：</p>
                
                <!-- 放置區塊 - 已調整為兩組 -->
                <div id="all-drop-zones" class="flex flex-wrap justify-center items-center">
                    
                    <!-- 第 1 個字 Pinyin Group -->
                    <div class="pinyin-group" id="pinyin-group-1">
                        <div id="initial-drop-1" data-type="initial" data-char="1" class="drop-zone rounded-xl flex items-center justify-center bg-white shadow-md text-gray-500">聲母</div>
                        <div id="final-drop-1" data-type="final" data-char="1" class="drop-zone rounded-xl flex items-center justify-center bg-white shadow-md text-gray-500">韻母</div>
                        <div id="tone-drop-1" data-type="tone" data-char="1" class="drop-zone rounded-full flex items-center justify-center bg-white shadow-md text-gray-500">聲調</div>
                    </div>
                    
                    <!-- 分隔符號 (雙字詞時顯示) -->
                    <div id="separator" class="hidden text-5xl sm:text-6xl font-bold text-gray-500 mx-4 sm:mx-6 my-2">|</div> 

                    <!-- 第 2 個字 Pinyin Group (雙字詞時才顯示) -->
                    <div class="pinyin-group hidden" id="pinyin-group-2">
                        <div id="initial-drop-2" data-type="initial" data-char="2" class="drop-zone rounded-xl flex items-center justify-center bg-white shadow-md text-gray-500">聲母</div>
                        <div id="final-drop-2" data-type="final" data-char="2" class="drop-zone rounded-xl flex items-center justify-center bg-white shadow-md text-gray-500">韻母</div>
                        <div id="tone-drop-2" data-type="tone" data-char="2" class="drop-zone rounded-full flex items-center justify-center bg-white shadow-md text-gray-500">聲調</div>
                    </div>

                </div>
            </div>

            <!-- 點選元件區塊 (會動態填充，分為三區) -->
            <div id="click-options-container" class="bg-blue-100 p-4 sm:p-6 rounded-lg shadow-lg">
                <p class="text-xl sm:text-2xl font-bold text-blue-800 mb-3 text-center">點擊選擇注音符號（每區僅顯示 5 個選項）：</p>
                
                <!-- 聲母選項區 -->
                <h3 class="text-lg font-bold text-gray-700 mt-4 mb-2 border-b">聲母 (Initial)</h3>
                <div id="initial-options" class="flex flex-wrap justify-center gap-2 sm:gap-3 p-2">
                    <!-- 聲母選項將在此處渲染 (最多 5 個) -->
                </div>
                
                <!-- 韻母選項區 -->
                <h3 class="text-lg font-bold text-gray-700 mt-4 mb-2 border-b">韻母 (Final)</h3>
                <div id="final-options" class="flex flex-wrap justify-center gap-2 sm:gap-3 p-2">
                    <!-- 韻母選項將在此處渲染 (最多 5 個) -->
                </div>
                
                <!-- 聲調選項區 -->
                <h3 class="text-lg font-bold text-gray-700 mt-4 mb-2 border-b">聲調 (Tone)</h3>
                <div id="tone-options" class="flex flex-wrap justify-center gap-2 sm:gap-3 p-2">
                    <!-- 聲調選項將在此處渲染 (最多 5 個) -->
                </div>
            </div>

            <!-- 提示區塊 (顯示拼出的字，幫助小一生確認) -->
            <div class="mt-6 text-center">
                <p class="text-xl sm:text-2xl font-semibold text-gray-700">
                    目前拼出的音：
                    <span id="pinyin-display" class="text-gray-400 text-4xl sm:text-5xl font-extrabold ml-2">
                        _ _ _
                    </span>
                </p>
                <button id="next-button" class="mt-4 px-6 py-3 bg-green-500 text-white text-xl font-bold rounded-full shadow-lg hover:bg-green-600 transition duration-300 transform hover:scale-105" disabled>
                    下一題 (完成後點擊)
                </button>
            </div>
        </div>

        <!-- 結果區塊 (遊戲結束後顯示) -->
        <div id="result-area" class="hidden text-center p-8 bg-green-50 border-4 border-green-500 rounded-xl shadow-2xl">
            <h2 class="text-5xl font-extrabold text-green-700 mb-6">時間到！遊戲結束！</h2>
            <p class="text-3xl font-bold text-gray-800 mb-4">
                您的最終得分：<span id="final-score" class="text-red-600 text-6xl ml-3">0</span> 題
            </p>
            <p class="text-xl text-gray-600 mb-8">表現很棒！休息一下再挑戰一次吧！</p>
            <button onclick="window.location.reload()" class="px-8 py-4 bg-red-500 text-white text-2xl font-bold rounded-full shadow-xl hover:bg-red-600 transition duration-300 transform hover:scale-105">
                再玩一次
            </button>
        </div>

        <!-- 錯誤訊息/操作提示 (自定義 modal，取代 alert) -->
        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center border-t-8 border-red-500">
                <p id="modal-message" class="text-xl font-semibold text-gray-700 mb-4">錯誤！</p>
                <button onclick="document.getElementById('modal').classList.add('hidden'); document.getElementById('modal').classList.remove('flex');" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                    確定
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 遊戲資料與設定 ---
        const GAME_DURATION = 180; // 3分鐘 = 180秒
        let timeLeft = GAME_DURATION;
        let timerInterval;
        let score = 0;
        let currentQuestionIndex = 0;
        
        // 統一的注音符號拼讀題目結構 (與前一版本相同)
        const QUESTIONS = [
            // 單字
            { id: 1, chinese: '巴', sound: 'ㄅㄚˉ', pinyin: [{ i: 'ㄅ', f: 'ㄚ', t: 'ˉ' }] },
            { id: 2, chinese: '坡', sound: 'ㄆㄛˉ', pinyin: [{ i: 'ㄆ', f: 'ㄛ', t: 'ˉ' }] },
            { id: 3, chinese: '米', sound: 'ㄇㄧˇ', pinyin: [{ i: 'ㄇ', f: 'ㄧ', t: 'ˇ' }] },
            { id: 4, chinese: '父', sound: 'ㄈㄨˋ', pinyin: [{ i: 'ㄈ', f: 'ㄨ', t: 'ˋ' }] },
            { id: 5, chinese: '的', sound: 'ㄉㄜ˙', pinyin: [{ i: 'ㄉ', f: 'ㄜ', t: '˙' }] },
            { id: 6, chinese: '台', sound: 'ㄊㄞˊ', pinyin: [{ i: 'ㄊ', f: 'ㄞ', t: 'ˊ' }] },
            { id: 7, chinese: '樓', sound: 'ㄌㄡˊ', pinyin: [{ i: 'ㄌ', f: 'ㄡ', t: 'ˊ' }] },
            { id: 8, chinese: '號', sound: 'ㄏㄠˋ', pinyin: [{ i: 'ㄏ', f: 'ㄠ', t: 'ˋ' }] },
            { id: 9, chinese: '決', sound: 'ㄐㄩㄝˊ', pinyin: [{ i: 'ㄐ', f: 'ㄩㄝ', t: 'ˊ' }] },
            { id: 10, chinese: '牆', sound: 'ㄑㄧㄤˊ', pinyin: [{ i: 'ㄑ', f: 'ㄧㄤ', t: 'ˊ' }] },
            { id: 11, chinese: '朽', sound: 'ㄒㄧㄡˇ', pinyin: [{ i: 'ㄒ', f: 'ㄧㄡ', t: 'ˇ' }] },
            { id: 12, chinese: '墜', sound: 'ㄓㄨㄟˋ', pinyin: [{ i: 'ㄓ', f: 'ㄨㄟ', t: 'ˋ' }] },
            
            // 雙字詞
            { id: 13, chinese: '蘋果', sound: 'ㄆㄧㄥˊ ㄍㄨㄛˇ', pinyin: [{ i: 'ㄆ', f: 'ㄧㄥ', t: 'ˊ' }, { i: 'ㄍ', f: 'ㄨㄛ', t: 'ˇ' }] },
            { id: 14, chinese: '學校', sound: 'ㄒㄩㄝˊ ㄒㄧㄠˋ', pinyin: [{ i: 'ㄒ', f: 'ㄩㄝ', t: 'ˊ' }, { i: 'ㄒ', f: 'ㄧㄠ', t: 'ˋ' }] },
            { id: 15, chinese: '鉛筆', sound: 'ㄑㄧㄢˉ ㄅㄧˇ', pinyin: [{ i: 'ㄑ', f: 'ㄧㄢ', t: 'ˉ' }, { i: 'ㄅ', f: 'ㄧ', t: 'ˇ' }] },
            { id: 16, chinese: '電腦', sound: 'ㄉㄧㄢˋ ㄋㄠˇ', pinyin: [{ i: 'ㄉ', f: 'ㄧㄢ', t: 'ˋ' }, { i: 'ㄋ', f: 'ㄠ', t: 'ˇ' }] },
            { id: 17, chinese: '蝴蝶', sound: 'ㄏㄨˊ ㄉㄧㄝˊ', pinyin: [{ i: 'ㄏ', f: 'ㄨ', t: 'ˊ' }, { i: 'ㄉ', f: 'ㄧㄝ', t: 'ˊ' }] },
            { id: 18, chinese: '哎唷', sound: 'ㄞˉ ㄧㄛˉ', pinyin: [{ i: '', f: 'ㄞ', t: 'ˉ' }, { i: '', f: 'ㄧㄛ', t: 'ˉ' }] },
            { id: 19, chinese: '牛奶', sound: 'ㄋㄧㄡˊ ㄋㄞˇ', pinyin: [{ i: 'ㄋ', f: 'ㄧㄡ', t: 'ˊ' }, { i: 'ㄋ', f: 'ㄞ', t: 'ˇ' }] },
            { id: 20, chinese: '螞蟻', sound: 'ㄇㄚˇ ㄧˇ', pinyin: [{ i: 'ㄇ', f: 'ㄚ', t: 'ˇ' }, { i: '', f: 'ㄧ', t: 'ˇ' }] },            { id: 21, chinese: '丟掉', sound: 'ㄉㄧㄡ ㄉㄧㄠˋ', pinyin: [{ i: 'ㄉ', f: 'ㄧㄡ', t: '' }, { i: 'ㄉ', f: 'ㄧㄠ', t: 'ˋ' }] },
            { id: 22, chinese: '右手', sound: 'ㄧㄡˋ ㄕㄡˇ', pinyin: [{ i: '', f: 'ㄧㄡ', t: 'ˋ' }, { i: 'ㄕ', f: 'ㄡ', t: 'ˇ' }] },
            { id: 23, chinese: '開門', sound: 'ㄎㄞˉ ㄇㄣˊ', pinyin: [{ i: 'ㄎ', f: 'ㄞ', t: 'ˉ' }, { i: 'ㄇ', f: 'ㄣ', t: 'ˊ' }] },
            { id: 24, chinese: '夢想', sound: 'ㄇㄥˋ ㄒㄧㄤˇ', pinyin: [{ i: 'ㄇ', f: 'ㄥ', t: 'ˋ' }, { i: 'ㄒ', f: 'ㄧㄤ', t: 'ˇ' }] },
            { id: 25, chinese: '精神', sound: 'ㄐㄧㄥˉ ㄕㄣˊ', pinyin: [{ i: 'ㄐ', f: 'ㄧㄥ', t: 'ˉ' }, { i: 'ㄕ', f: 'ㄣ', t: 'ˊ' }] },
            { id: 26, chinese: '親吻', sound: 'ㄑㄧㄣˉ ㄨㄣˇ', pinyin: [{ i: 'ㄑ', f: 'ㄧㄣ', t: 'ˉ' }, { i: '', f: 'ㄨㄣ', t: 'ˇ' }] },
            { id: 27, chinese: '身體', sound: 'ㄕㄣˉ ㄊㄧˇ', pinyin: [{ i: 'ㄕ', f: 'ㄣ', t: 'ˉ' }, { i: 'ㄊ', f: 'ㄧ', t: 'ˇ' }] },
            { id: 28, chinese: '分數', sound: 'ㄈㄣˉ ㄕㄨˋ', pinyin: [{ i: 'ㄈ', f: 'ㄣ', t: 'ˉ' }, { i: 'ㄕ', f: 'ㄨ', t: 'ˋ' }] },
            { id: 29, chinese: '生日', sound: 'ㄕㄥˉ ㄖˋ', pinyin: [{ i: 'ㄕ', f: 'ㄥ', t: 'ˉ' }, { i: 'ㄖ', f: '', t: 'ˋ' }] },
            { id: 30, chinese: '聲音', sound: 'ㄕㄥˉ ㄧㄣˉ', pinyin: [{ i: 'ㄕ', f: 'ㄥ', t: 'ˉ' }, { i: '', f: 'ㄧㄣ', t: 'ˉ' }] },
            { id: 31, chinese: '早上', sound: 'ㄗㄠˇ ㄕㄤˋ', pinyin: [{ i: 'ㄗ', f: 'ㄠ', t: 'ˇ' }, { i: 'ㄕ', f: 'ㄤ', t: 'ˋ' }] },
            { id: 32, chinese: '音樂', sound: 'ㄧㄣˉ ㄩㄝˋ', pinyin: [{ i: '', f: 'ㄧㄣ', t: 'ˉ' }, { i: '', f: 'ㄩㄝ', t: 'ˋ' }] },
            { id: 33, chinese: '魔法', sound: 'ㄇㄛˊ ㄈㄚˇ', pinyin: [{ i: 'ㄇ', f: 'ㄛ', t: 'ˊ' }, { i: 'ㄈ', f: 'ㄚ', t: 'ˇ' }] },
            { id: 34, chinese: '環繞', sound: 'ㄏㄨㄢˊ ㄖㄠˋ', pinyin: [{ i: 'ㄏ', f: 'ㄨㄢ', t: 'ˊ' }, { i: 'ㄖ', f: 'ㄠ', t: 'ˋ' }] },
            { id: 35, chinese: '老鷹', sound: 'ㄌㄠˇ ㄧㄥˉ', pinyin: [{ i: 'ㄌ', f: 'ㄠ', t: 'ˇ' }, { i: '', f: 'ㄧㄥ', t: 'ˉ' }] },
            { id: 36, chinese: '恐龍', sound: 'ㄎㄨㄥˇ ㄌㄨㄥˊ', pinyin: [{ i: 'ㄎ', f: 'ㄨㄥ', t: 'ˇ' }, { i: 'ㄌ', f: 'ㄨㄥ', t: 'ˊ' }] },
            { id: 37, chinese: '冰棒', sound: 'ㄅㄧㄥˉ ㄅㄤˋ', pinyin: [{ i: 'ㄅ', f: 'ㄧㄥ', t: 'ˉ' }, { i: 'ㄅ', f: 'ㄤ', t: 'ˋ' }] },
            { id: 38, chinese: '樹根', sound: 'ㄕㄨˋ ㄍㄣˉ', pinyin: [{ i: 'ㄕ', f: 'ㄨ', t: 'ˋ' }, { i: 'ㄍ', f: 'ㄣ', t: 'ˉ' }] },
            { id: 39, chinese: '灰塵', sound: 'ㄏㄨㄟˉ ㄔㄣˊ', pinyin: [{ i: 'ㄏ', f: 'ㄨㄟ', t: 'ˉ' }, { i: 'ㄔ', f: 'ㄣ', t: 'ˊ' }] },
            { id: 40, chinese: '緊張', sound: 'ㄐㄧㄣˇ ㄓㄤˉ', pinyin: [{ i: 'ㄐ', f: 'ㄧㄣ', t: 'ˇ' }, { i: 'ㄓ', f: 'ㄤ', t: 'ˉ' }] },
            { id: 41, chinese: '愛心', sound: 'ㄞˋ ㄒㄧㄣˉ', pinyin: [{ i: '', f: 'ㄞ', t: 'ˋ' }, { i: 'ㄒ', f: 'ㄧㄣ', t: 'ˉ' }] },
            { id: 42, chinese: '鳳梨', sound: 'ㄈㄥˋ ㄌㄧˊ', pinyin: [{ i: 'ㄈ', f: 'ㄥ', t: 'ˋ' }, { i: 'ㄌ', f: 'ㄧ', t: 'ˊ' }] },
            { id: 43, chinese: '檸檬', sound: 'ㄋㄧㄥˊ ㄇㄥˊ', pinyin: [{ i: 'ㄋ', f: 'ㄧㄥ', t: 'ˊ' }, { i: 'ㄇ', f: 'ㄥ', t: 'ˊ' }] },
            { id: 44, chinese: '碰撞', sound: 'ㄆㄥˋ ㄓㄨㄤˋ', pinyin: [{ i: 'ㄆ', f: 'ㄥ', t: 'ˋ' }, { i: 'ㄓ', f: 'ㄨㄤ', t: 'ˋ' }] },
            { id: 45, chinese: '糖果', sound: 'ㄊㄤˊ ㄍㄨㄛˇ', pinyin: [{ i: 'ㄊ', f: 'ㄤ', t: 'ˊ' }, { i: 'ㄍ', f: 'ㄨㄛ', t: 'ˇ' }] },
            { id: 46, chinese: '小偷', sound: 'ㄒㄧㄠˇ ㄊㄡˉ', pinyin: [{ i: 'ㄒ', f: 'ㄧㄠ', t: 'ˇ' }, { i: 'ㄊ', f: 'ㄡ', t: 'ˉ' }] },
            { id: 47, chinese: '鐵塔', sound: 'ㄊㄧㄝˇ ㄊㄚˇ', pinyin: [{ i: 'ㄊ', f: 'ㄧㄝ', t: 'ˇ' }, { i: 'ㄊ', f: 'ㄚ', t: 'ˇ' }] },
            { id: 48, chinese: '猴子', sound: 'ㄏㄡˊ ˙ㄗ', pinyin: [{ i: 'ㄏ', f: 'ㄡ', t: 'ˊ' }, { i: 'ㄗ', f: '', t: '˙' }] },
            { id: 49, chinese: '小狗', sound: 'ㄒㄧㄠˇ ㄍㄡˇ', pinyin: [{ i: 'ㄒ', f: 'ㄧㄠ', t: 'ˇ' }, { i: 'ㄍ', f: 'ㄡ', t: 'ˇ' }] },
            { id: 50, chinese: '爺爺', sound: 'ㄧㄝˊ ˙ㄧㄝ', pinyin: [{ i: '', f: 'ㄧㄝ', t: 'ˊ' }, { i: '', f: 'ㄧㄝ', t: '˙' }] },
            { id: 51, chinese: '靴子', sound: 'ㄒㄩㄝˉ ˙ㄗ', pinyin: [{ i: 'ㄒ', f: 'ㄩㄝ', t: 'ˉ' }, { i: 'ㄗ', f: '', t: '˙' }] },
            { id: 52, chinese: '巫婆', sound: 'ㄨˉ ㄆㄛˊ', pinyin: [{ i: '', f: 'ㄨ', t: 'ˉ' }, { i: 'ㄆ', f: 'ㄛ', t: 'ˊ' }] },
            { id: 53, chinese: '玻璃', sound: 'ㄅㄛˉ ㄌㄧˊ', pinyin: [{ i: 'ㄅ', f: 'ㄛ', t: 'ˉ' }, { i: 'ㄌ', f: 'ㄧ', t: 'ˊ' }] },
            { id: 54, chinese: '抹布', sound: 'ㄇㄛˇ ㄅㄨˋ', pinyin: [{ i: 'ㄇ', f: 'ㄛ', t: 'ˇ' }, { i: 'ㄅ', f: 'ㄨ', t: 'ˋ' }] },
            { id: 55, chinese: '蚯蚓', sound: 'ㄑㄧㄡˉ ㄧㄣˇ', pinyin: [{ i: 'ㄑ', f: 'ㄧㄡ', t: 'ˉ' }, { i: '', f: 'ㄧㄣ', t: 'ˇ' }] },
            { id: 56, chinese: '朋友', sound: 'ㄆㄥˊ ㄧㄡˇ', pinyin: [{ i: 'ㄆ', f: 'ㄥ', t: 'ˊ' }, { i: '', f: 'ㄧㄡ', t: 'ˇ' }] },
            { id: 57, chinese: '眼睛', sound: 'ㄧㄢˇ ㄐㄧㄥˉ', pinyin: [{ i: '', f: 'ㄧㄢ', t: 'ˇ' }, { i: 'ㄐ', f: 'ㄧㄥ', t: 'ˉ' }] },
            { id: 58, chinese: '隱形', sound: 'ㄧㄣˇ ㄒㄧㄥˊ', pinyin: [{ i: '', f: 'ㄧㄣ', t: 'ˇ' }, { i: 'ㄒ', f: 'ㄧㄥ', t: 'ˊ' }] },
            { id: 59, chinese: '聰明', sound: 'ㄘㄨㄥˉ ㄇㄧㄥˊ', pinyin: [{ i: 'ㄘ', f: 'ㄨㄥ', t: 'ˉ' }, { i: 'ㄇ', f: 'ㄧㄥ', t: 'ˊ' }] },
            { id: 60, chinese: '足球', sound: 'ㄗㄨˊ ㄑㄧㄡˊ', pinyin: [{ i: 'ㄗ', f: 'ㄨ', t: 'ˊ' }, { i: 'ㄑ', f: 'ㄧㄡ', t: 'ˊ' }] },
            { id: 61, chinese: '洗澡', sound: 'ㄒㄧˇ ㄗㄠˇ', pinyin: [{ i: 'ㄒ', f: 'ㄧ', t: 'ˇ' }, { i: 'ㄗ', f: 'ㄠ', t: 'ˇ' }] },
            { id: 62, chinese: '老虎', sound: 'ㄌㄠˇ ㄏㄨˇ', pinyin: [{ i: 'ㄌ', f: 'ㄠ', t: 'ˇ' }, { i: 'ㄏ', f: 'ㄨ', t: 'ˇ' }] },
            { id: 63, chinese: '勇敢', sound: 'ㄩㄥˇ ㄍㄢˇ', pinyin: [{ i: '', f: 'ㄩㄥ', t: 'ˇ' }, { i: 'ㄍ', f: 'ㄢ', t: 'ˇ' }] },
            { id: 64, chinese: '城堡', sound: 'ㄔㄥˊ ㄅㄠˇ', pinyin: [{ i: 'ㄔ', f: 'ㄥ', t: 'ˊ' }, { i: 'ㄅ', f: 'ㄠ', t: 'ˇ' }] },
            { id: 65, chinese: '警察', sound: 'ㄐㄧㄥˇ ㄔㄚˊ', pinyin: [{ i: 'ㄐ', f: 'ㄧㄥ', t: 'ˇ' }, { i: 'ㄔ', f: 'ㄚ', t: 'ˊ' }] },
            { id: 66, chinese: '檯燈', sound: 'ㄊㄞˊ ㄉㄥˉ', pinyin: [{ i: 'ㄊ', f: 'ㄞ', t: 'ˊ' }, { i: 'ㄉ', f: 'ㄥ', t: 'ˉ' }] },
            { id: 67, chinese: '鈴鐺', sound: 'ㄌㄧㄥˊ ㄉㄤˉ', pinyin: [{ i: 'ㄌ', f: 'ㄧㄥ', t: 'ˊ' }, { i: 'ㄉ', f: 'ㄤ', t: 'ˉ' }] },
            { id: 68, chinese: '牽手', sound: 'ㄑㄧㄢˉ ㄕㄡˇ', pinyin: [{ i: 'ㄑ', f: 'ㄧㄢ', t: 'ˉ' }, { i: 'ㄕ', f: 'ㄡ', t: 'ˇ' }] },
        ];

        // 完整的注音符號庫
        const INITIAL_TILES = ['ㄅ', 'ㄆ', 'ㄇ', 'ㄈ', 'ㄉ', 'ㄊ', 'ㄋ', 'ㄌ', 'ㄍ', 'ㄎ', 'ㄏ', 'ㄐ', 'ㄑ', 'ㄒ', 'ㄓ', 'ㄔ', 'ㄕ', 'ㄖ', 'ㄗ', 'ㄘ', 'ㄙ'];
        const FINAL_TILES = ['ㄚ', 'ㄛ', 'ㄜ', 'ㄝ', 'ㄞ', 'ㄟ', 'ㄠ', 'ㄡ', 'ㄢ', 'ㄣ', 'ㄤ', 'ㄥ', 'ㄦ', 'ㄧ', 'ㄨ', 'ㄩ', 'ㄧㄚ', 'ㄧㄝ', 'ㄧㄠ', 'ㄧㄡ', 'ㄧㄢ', 'ㄧㄣ', 'ㄧㄤ', 'ㄧㄥ', 'ㄨㄚ', 'ㄨㄛ', 'ㄨㄞ', 'ㄨㄟ', 'ㄨㄢ', 'ㄨㄣ', 'ㄨㄤ', 'ㄨㄥ', 'ㄩㄝ', 'ㄩㄢ', 'ㄩㄣ', 'ㄩㄥ']; 
        const TONE_TILES = ['ˉ', 'ˊ', 'ˇ', 'ˋ', '˙'];

        const TILE_MAP = {
            'initial': INITIAL_TILES,
            'final': FINAL_TILES,
            'tone': TONE_TILES
        };
        const MAX_OPTIONS_COUNT = 5; // 限制選項數量為 5

      

        // --- DOM 元素快取 ---
        const timerEl = document.getElementById('timer');
        const scoreEl = document.getElementById('score');
        const gameAreaEl = document.getElementById('game-area');
        const resultAreaEl = document.getElementById('result-area');
        const initialOptionsEl = document.getElementById('initial-options');
        const finalOptionsEl = document.getElementById('final-options');
        const toneOptionsEl = document.getElementById('tone-options');
        const pinyinDisplayEl = document.getElementById('pinyin-display');
        const nextButtonEl = document.getElementById('next-button');
        const modalEl = document.getElementById('modal');
        const chineseHintEl = document.getElementById('chinese-hint');
        const speakButtonEl = document.getElementById('speak-button');
        const speakerIconEl = document.getElementById('speaker-icon');
        const loadingSpinnerEl = document.getElementById('loading-spinner');

        // 快取放置區 DOM 元素
        const dropZones = [
            { i: document.getElementById('initial-drop-1'), f: document.getElementById('final-drop-1'), t: document.getElementById('tone-drop-1') },
            { i: document.getElementById('initial-drop-2'), f: document.getElementById('final-drop-2'), t: document.getElementById('tone-drop-2') }
        ];
        const pinyinGroup2El = document.getElementById('pinyin-group-2');
        const separatorEl = document.getElementById('separator');


        // --- 工具函數 (TTS 音訊處理) ---
        function showModal(message) {
            document.getElementById('modal-message').textContent = message;
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        function pcmToWav(pcm16, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcm16.byteLength);
            const view = new DataView(buffer);
            const channelCount = 1;
            const byteRate = sampleRate * channelCount * 2;
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.byteLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, channelCount, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, channelCount * 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.byteLength, true);
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }
            return new Blob([view], { type: 'audio/wav' });
        }
        
        function speakQuestionSound(text) {
            speakButtonEl.disabled = true;
            speakerIconEl.classList.add('hidden');
            loadingSpinnerEl.classList.remove('hidden');

            const safeText = encodeURIComponent(text);
            const filename = `audios/${safeText}.mp3`;
            const audio = new Audio(filename);

            // 💡 修正邏輯：先嘗試播放，如果失敗（通常是未載入或播放權限），
            // 則監聽 'canplaythrough' 事件，確保音訊已完整載入後再播放。

            function playAudio() {
                audio.play()
                .then(() => {
                    // 成功播放，監聽結束事件
                    audio.onended = () => {
                        speakButtonEl.disabled = false;
                        speakerIconEl.classList.remove('hidden');
                        loadingSpinnerEl.classList.add('hidden');
                    };
                })
                .catch(err => {
                    // 播放失敗，可能是因為瀏覽器還沒載入或權限問題。
                    // 由於這是自動播放，我們將嘗試等待載入完成。
                    console.error("首次播放嘗試失敗，等待載入中...", err);
                    
                    // 1. 檢查是否是瀏覽器權限問題 (但通常只會失敗一次)
                    if (err.name === "NotAllowedError" || err.name === "AbortError") {
                        // 如果是權限問題，則直接解除按鈕禁用，讓使用者點擊
                        speakButtonEl.disabled = false;
                        speakerIconEl.classList.remove('hidden');
                        loadingSpinnerEl.classList.add('hidden');
                        showModal("瀏覽器可能阻擋了自動播放。請點擊喇叭圖示播放音檔。");
                        return;
                    }

                    // 2. 如果不是權限問題，監聽載入完成事件
                    if (audio.readyState < 4) { // 檢查是否尚未載入完成 (HAVE_ENOUGH_DATA)
                        audio.addEventListener('canplaythrough', () => {
                            console.log("音訊載入完成，重新嘗試播放。");
                            playAudio(); // 重新呼叫播放
                        }, { once: true });
                    } else {
                        // 載入已完成但播放仍失敗，顯示錯誤
                        console.error("音訊載入完成後播放仍失敗:", err);
                        showModal("語音無法播放，請檢查是否有對應音檔或網路連線。");
                        speakButtonEl.disabled = false;
                        speakerIconEl.classList.remove('hidden');
                        loadingSpinnerEl.classList.add('hidden');
                    }
                });
            }

            playAudio();
        }


        // --- 遊戲邏輯：點擊模式 (新增動態選項生成) ---

        /**
         * 產生包含正確答案且總數為 MAX_OPTIONS_COUNT (5) 的不重複選項。
         * @param {string} type - 類型 (initial, final, tone)
         * @param {string[]} requiredValues - 該題正確答案所需的所有符號
         * @returns {string[]} 包含正確答案的最多 5 個選項
         */
        function getLimitedOptions(type, requiredValues) {
            const allOptions = TILE_MAP[type];
            const optionSet = new Set(requiredValues); // 1. 先加入所有正確答案

            // 2. 隨機加入其他不重複的選項，直到達到最大限制或選項用盡
            let attempts = 0;
            const maxAttempts = allOptions.length * 2; // 安全限制
            while (optionSet.size < MAX_OPTIONS_COUNT && optionSet.size < allOptions.length && attempts < maxAttempts) {
                const randomIndex = Math.floor(Math.random() * allOptions.length);
                const randomTile = allOptions[randomIndex];
                // 確保加入的不是已有的
                optionSet.add(randomTile);
                attempts++;
            }
            
            return Array.from(optionSet);
        }

        /**渲染動態產生的 5 個選項**/
        function generateAndRenderOptions() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            
            // 1. 收集該題所需的正確注音符號
            const requiredInitials = [];
            const requiredFinals = [];
            const requiredTones = [];

            currentQ.pinyin.forEach(p => {
                requiredInitials.push(p.i);
                requiredFinals.push(p.f);
                requiredTones.push(p.t);
            });

            // 2. 產生包含正確答案的限量選項集
            const initialTilesLimited = getLimitedOptions('initial', requiredInitials);
            const finalTilesLimited = getLimitedOptions('final', requiredFinals);
            const toneTilesLimited = getLimitedOptions('tone', requiredTones);

            // 清空所有選項區
            initialOptionsEl.innerHTML = '';
            finalOptionsEl.innerHTML = '';
            toneOptionsEl.innerHTML = '';

            const renderTiles = (container, tiles, type) => {
                shuffleArray(tiles); // 打亂選項順序
                tiles.forEach(value => {
                    const div = document.createElement('div');
                    div.textContent = value;
                    div.dataset.value = value;
                    div.dataset.type = type;
                    div.classList.add('click-tile', 'bg-white', 'text-gray-800', 'text-3xl', 'sm:text-4xl', 'font-bold', 'rounded-lg', 'shadow-md', 'p-3', 'sm:p-4', 'w-16', 'h-16', 'sm:w-20', 'sm:h-20', 'flex', 'items-center', 'justify-center', 'transform', 'hover:shadow-lg', 'border-blue-400');
                    
                    div.addEventListener('click', handleTileClick);
                    container.appendChild(div);
                });
            };

            // 3. 渲染有限的選項
            renderTiles(initialOptionsEl, initialTilesLimited, 'initial');
            renderTiles(finalOptionsEl, finalTilesLimited, 'final');
            renderTiles(toneOptionsEl, toneTilesLimited, 'tone');
        }

        /**檢查所有拼讀區是否都被正確填滿@returns {boolean}**/
        function checkCompletion() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            let isComplete = true;

            for (let i = 0; i < currentQ.pinyin.length; i++) {
                const expected = currentQ.pinyin[i];
                const group = dropZones[i]; // group 0 is char 1, group 1 is char 2
                
                // 檢查是否與期望值匹配
                if (group.i.dataset.value !== expected.i ||
                    group.f.dataset.value !== expected.f ||
                    group.t.dataset.value !== expected.t) {
                    isComplete = false;
                    break;
                }
            }
            return isComplete;
        }

        /**更新目前拼讀區的顯示**/
        function updatePinyinDisplay() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            let pinyinText = [];
            
            for (let i = 0; i < currentQ.pinyin.length; i++) {
                const group = dropZones[i];
                const initial = group.i.dataset.value || '_';
                const final = group.f.dataset.value || '_';
                const tone = group.t.dataset.value || '_';
                
                pinyinText.push(`${initial}${final}${tone}`);
            }
            
            pinyinDisplayEl.textContent = pinyinText.join(' ');


            if (checkCompletion()) {
                pinyinDisplayEl.textContent = currentQ.sound;
                pinyinDisplayEl.classList.add('text-green-600');
                pinyinDisplayEl.classList.remove('text-gray-400');
                nextButtonEl.disabled = false;

                // 為正確填入的 drop zone 添加最終樣式 (僅視覺確認，點擊可移除)
                document.querySelectorAll('.drop-zone').forEach(el => {
                    if(el.dataset.value) {
                         el.classList.add('completed-answer');
                         el.classList.remove('bg-white', 'text-gray-500');
                    }
                });

            } else {
                pinyinDisplayEl.classList.remove('text-green-600');
                pinyinDisplayEl.classList.add('text-gray-400');
                nextButtonEl.disabled = true;

                // 移除完成樣式
                document.querySelectorAll('.drop-zone').forEach(el => {
                    el.classList.remove('completed-answer');
                });
            }
        }

        /**處理點擊選項區注音符號的事件**/
        function handleTileClick(e) {
            const clickedTile = e.currentTarget;
            const value = clickedTile.dataset.value;
            const type = clickedTile.dataset.type;
            const currentQ = QUESTIONS[currentQuestionIndex];

            // 🔹 定義類型映射，因為 dropZones 使用 i/f/t，而 dataset 使用 initial/final/tone
            const typeMap = { 'initial': 'i', 'final': 'f', 'tone': 't' };
            
            let targetDropZone = null;

            // 🔹 邏輯：遍歷所有可能的拼音組 (最多兩組)
            for (let i = 0; i < currentQ.pinyin.length; i++) {
                const expected = currentQ.pinyin[i]; // 期望的正確答案 ({i: 'ㄉ', f: 'ㄧㄡ', t: 'ˉ'})
                const group = dropZones[i];
                
                // 獲取當前組中對應類型的放置區元素
                const dropElKey = typeMap[type]; // 'i', 'f', or 't'
                const dropEl = group[dropElKey]; // 實際的 DOM 元素 (initial-drop-1, final-drop-1, etc.)
                
                // 檢查條件：
                // 1. 放置區必須是空的 (`!dropEl.dataset.value`)
                // 2. 該放置區的「期望答案」必須與玩家點擊的「符號值」相等 (`expected[dropElKey] === value`)
                if (!dropEl.dataset.value && expected[dropElKey] === value) {
                    targetDropZone = dropEl;
                    break; // ✅ 找到該符號正確的歸屬格，就填這裡
                }
            }

            // 若都沒找到相符位置
            if (!targetDropZone) {
                // 如果玩家點擊了空的聲母/韻母選項 ("")，但該題不需要
                if (value === "") { 
                    showModal(`您選擇了「空」符號，但本題中所有屬於「${type}」的空位都不需要空字串來填補！`);
                } else {
                    showModal(`您選擇的符號 (${value}) 並不屬於此題答案的正確位置！`);
                }
                return;
            }

            // 🔹 成功填入
            targetDropZone.textContent = value === "" ? "（空）" : value; // 對空字串顯示提示
            targetDropZone.dataset.value = value;
            
            // 樣式更新：使用藍色背景表示已填入
            targetDropZone.classList.remove('bg-white', 'text-gray-500');
            targetDropZone.classList.add('text-white', 'bg-blue-500');

            // ⚠️ 關鍵修正：這裡不再禁用選項！
            // 移除原有的: clickedTile.classList.add('selected'); 
            // 移除原有的: clickedTile.style.opacity = '0.3'; 
            // 移除原有的: clickedTile.style.pointerEvents = 'none'; 
            
            updatePinyinDisplay();
        }        

        /**處理點擊已填入的放置區的事件 (還原)**/
        function handleDropZoneClick(e) {
            const dropZone = e.currentTarget;
            const value = dropZone.dataset.value;
            const type = dropZone.dataset.type;

            if (!value) return; // 如果是空的，不做任何事

            // 1. **移除**找到來源選項元素並重新啟用的邏輯 (因為選項本身就沒有被禁用)

            // 2. 清空放置區
            dropZone.textContent = type === 'initial' ? '聲母' : (type === 'final' ? '韻母' : '聲調');
            dropZone.dataset.value = '';
            dropZone.classList.remove('completed-answer', 'text-white', 'bg-blue-500');
            dropZone.classList.add('bg-white', 'text-gray-500');

            updatePinyinDisplay();
        }


        /**設定放置區為初始狀態，並根據題目顯示數量**/
        function resetDropZones() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            const isTwoChar = currentQ.pinyin.length === 2;

            pinyinGroup2El.classList.toggle('hidden', !isTwoChar);
            separatorEl.classList.toggle('hidden', !isTwoChar);

            // 重設所有放置區
            dropZones.forEach(group => {
                Object.values(group).forEach(el => {
                    // 恢復預設文字
                    el.innerHTML = el.dataset.type === 'initial' ? '聲母' : (el.dataset.type === 'final' ? '韻母' : '聲調');
                    // 恢復預設樣式
                    el.classList.remove('completed-answer', 'text-white', 'bg-blue-500');
                    el.classList.add('bg-white', 'text-gray-500');
                    el.dataset.value = ''; // 清除已放置的值
                });
            });
            
            // 重新渲染選項，確保它們都處於未選中狀態
            generateAndRenderOptions();
        }
        
        /**更新國字提示的顯示**/
        function updateQuestionDisplay() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            chineseHintEl.textContent = currentQ.chinese;
        }

        /**開始下一題**/
        function nextQuestion() {
            if (checkCompletion()) {
                score++;
                scoreEl.textContent = score;
            }

            if (currentQuestionIndex < QUESTIONS.length - 1) {
                currentQuestionIndex++;
            } else {
                shuffleArray(QUESTIONS); 
                currentQuestionIndex = 0;
                showModal("太棒了！您已完成所有題目！現在將重新開始一輪挑戰，直到時間結束。");
            }
            
            resetDropZones(); // 這裡會呼叫 generateAndRenderOptions
            updatePinyinDisplay();
            updateQuestionDisplay();
            nextButtonEl.disabled = true;
            // 🚀 新增：自動播放當前題目的音檔

            const currentQ = QUESTIONS[currentQuestionIndex];
            speakQuestionSound(currentQ.sound);
        }

        /**初始化事件監聽**/
        function initListeners() {
            // 放置區監聽：點擊還原 (只需要設定一次)
            document.querySelectorAll('.drop-zone').forEach(el => {
                el.addEventListener('click', handleDropZoneClick);
            });
            
            nextButtonEl.addEventListener('click', nextQuestion);
            
            // TTS 語音播放按鈕事件
            speakButtonEl.addEventListener('click', () => {
                const currentQ = QUESTIONS[currentQuestionIndex];
                speakQuestionSound(currentQ.sound);
            });
        }

        /**開始遊戲計時器**/
        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = formatTime(timeLeft);

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }, 1000);
        }

        /**遊戲結束**/
        function endGame() {
            clearInterval(timerInterval);
            gameAreaEl.classList.add('hidden');
            resultAreaEl.classList.remove('hidden');
            document.getElementById('final-score').textContent = score;
        }

        /**遊戲初始化**/
        function initializeGame() {
            shuffleArray(QUESTIONS); // 打亂題目順序
            currentQuestionIndex = 0;
            score = 0;
            timeLeft = GAME_DURATION;
            scoreEl.textContent = score;
            timerEl.textContent = formatTime(timeLeft);
            gameAreaEl.classList.remove('hidden');
            resultAreaEl.classList.add('hidden');

            // 初始題目設定及選項渲染
            initListeners(); // 初始化事件監聽
            resetDropZones(); // 這裡會呼叫 generateAndRenderOptions
            updatePinyinDisplay();
            updateQuestionDisplay(); 
            
            startTimer();

            // 🚀 新增：遊戲開始時，自動播放第一題的音檔
            const currentQ = QUESTIONS[currentQuestionIndex];
            speakQuestionSound(currentQ.sound);
        }

        // 頁面載入完成後開始遊戲
        window.onload = initializeGame;

    </script>
</body>
</html>
