<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨éŸ³ç¬¦è™Ÿæ‹¼è®€é»é¸éŠæˆ²</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨æ•™è‚²éƒ¨æ¨è–¦çš„å­—é«” (å¦‚: Inter)ï¼Œä¸¦å¢åŠ æ³¨éŸ³ç¬¦è™Ÿçš„è¾¨è­˜åº¦ */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* é»é¸å…ƒä»¶æ¨£å¼ */
        .click-tile {
            cursor: pointer;
            user-select: none;
            transition: transform 0.15s ease-out, background-color 0.15s ease-out, opacity 0.3s;
            border: 2px solid transparent;
        }
        .click-tile:hover {
            transform: scale(1.05);
            background-color: #fcd34d; /* æ·ºé»ƒè‰² */
        }
        .click-tile.selected {
            opacity: 0.3; /* é¸ä¸­å¾Œè®Šæ·¡ï¼Œè¡¨ç¤ºå·²è¢«ä½¿ç”¨ */
            pointer-events: none; /* ç¦ç”¨é»æ“Š */
        }
        /* æ”¾ç½®å€æ¨£å¼ */
        .drop-zone {
            border: 3px dashed #9ca3af; /* ç°è‰²è™›ç·š */
            transition: background-color 0.2s;
            cursor: pointer; /* é»æ“Šå¯ç§»é™¤ */
        }
        .drop-zone:hover:not(.completed-answer) {
            background-color: #fef3c7; /* æ·ºé»ƒè‰²æç¤ºå¯é»æ“Š */
        }
        .drop-zone.completed-answer {
            background-color: #3b82f6; /* è—è‰²èƒŒæ™¯ (å·²å¡«å…¥) */
            color: #ffffff;
            border-style: solid;
            border-color: #2563eb;
        }
        /* èª¿æ•´åœ‹å­—æç¤ºå­—é«”å¤§å°ä»¥å®¹ç´äºŒå­—è© */
        #chinese-hint {
            font-size: clamp(3rem, 10vw, 5rem); /* RWD å­—é«”å¤§å° */
        }
        /* Pinyin Group wrapper for consistent spacing */
        .pinyin-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem; /* Space between initial, final, tone */
        }
        /* èª¿æ•´æ”¾ç½®å€å¤§å° */
        .drop-zone[data-type="tone"] {
            width: 4rem; 
            height: 4rem; 
            font-size: 1.875rem; 
        }
        .drop-zone[data-type="initial"], 
        .drop-zone[data-type="final"] {
            width: 6rem; 
            height: 6rem; 
            font-size: 2.25rem; 
        }
        @media (min-width: 640px) {
            .drop-zone[data-type="tone"] {
                width: 5rem; 
                height: 5rem; 
                font-size: 3rem; 
            }
            .drop-zone[data-type="initial"], 
            .drop-zone[data-type="final"] {
                width: 8rem; 
                height: 8rem; 
                font-size: 3.75rem; 
            }
        }
    </style>
</head>

<body class="p-4 sm:p-8">

    <div id="game-container" class="w-full max-w-5xl bg-white shadow-2xl rounded-xl p-6 sm:p-10 border-4 border-yellow-400">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-center text-red-600 mb-6 tracking-wide">
            æ³¨éŸ³ç¬¦è™Ÿé»é¸æ‹¼è®€
        </h1>

        <!-- éŠæˆ²è³‡è¨Šï¼šè¨ˆæ™‚å™¨èˆ‡åˆ†æ•¸ -->
        <div class="flex justify-between items-center mb-8 border-b-2 pb-4">
            <div class="text-xl sm:text-2xl font-bold text-gray-700">
                è¨ˆæ™‚å™¨: <span id="timer" class="text-red-500 text-3xl sm:text-4xl ml-2">3:00</span>
            </div>
            <div class="text-xl sm:text-2xl font-bold text-gray-700">
                åˆ†æ•¸: <span id="score" class="text-blue-500 text-3xl sm:text-4xl ml-2">0</span>
            </div>
        </div>

        <!-- éŠæˆ²å€å¡Š -->
        <div id="game-area">
            <!-- é¡Œç›®å€å¡Š -->
            <div class="mb-8 text-center bg-yellow-100 p-4 rounded-lg shadow-inner">
                
                <!-- åœ‹å­—æç¤ºå€å¡Š + èªéŸ³æŒ‰éˆ• -->
                <div class="flex flex-col items-center justify-center mb-6">
                    <div id="chinese-hint" class="font-extrabold text-red-700 p-4 bg-white rounded-xl shadow-lg mb-4">
                        <!-- åœ‹å­—æœƒåœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                    <!-- èªéŸ³æ’­æ”¾æŒ‰éˆ• -->
                    <button id="speak-button" class="bg-red-500 text-white p-4 rounded-full shadow-xl hover:bg-red-600 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <!-- Speaker Icon -->
                        <svg id="speaker-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                        </svg>
                        <!-- Loading Spinner -->
                        <div id="loading-spinner" class="hidden h-6 w-6 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                    </button>
                    <p class="text-sm mt-2 text-red-500 font-semibold">ï¼ˆé»æ“Šä¸Šæ–¹æŒ‰éˆ•è½**ç›®æ¨™ç™¼éŸ³**ï¼‰</p>
                </div>
                
                <p class="text-2xl sm:text-3xl font-semibold text-gray-800 mb-3">é»æ“Šæ³¨éŸ³ç¬¦è™Ÿï¼Œå°‡å®ƒå¡«å…¥æ­£ç¢ºä½ç½®ï¼š</p>
                
                <!-- æ”¾ç½®å€å¡Š - å·²èª¿æ•´ç‚ºå…©çµ„ -->
                <div id="all-drop-zones" class="flex flex-wrap justify-center items-center">
                    
                    <!-- ç¬¬ 1 å€‹å­— Pinyin Group -->
                    <div class="pinyin-group" id="pinyin-group-1">
                        <div id="initial-drop-1" data-type="initial" data-char="1" class="drop-zone rounded-xl flex items-center justify-center bg-white shadow-md text-gray-500">è²æ¯</div>
                        <div id="final-drop-1" data-type="final" data-char="1" class="drop-zone rounded-xl flex items-center justify-center bg-white shadow-md text-gray-500">éŸ»æ¯</div>
                        <div id="tone-drop-1" data-type="tone" data-char="1" class="drop-zone rounded-full flex items-center justify-center bg-white shadow-md text-gray-500">è²èª¿</div>
                    </div>
                    
                    <!-- åˆ†éš”ç¬¦è™Ÿ (é›™å­—è©æ™‚é¡¯ç¤º) -->
                    <div id="separator" class="hidden text-5xl sm:text-6xl font-bold text-gray-500 mx-4 sm:mx-6 my-2">|</div> 

                    <!-- ç¬¬ 2 å€‹å­— Pinyin Group (é›™å­—è©æ™‚æ‰é¡¯ç¤º) -->
                    <div class="pinyin-group hidden" id="pinyin-group-2">
                        <div id="initial-drop-2" data-type="initial" data-char="2" class="drop-zone rounded-xl flex items-center justify-center bg-white shadow-md text-gray-500">è²æ¯</div>
                        <div id="final-drop-2" data-type="final" data-char="2" class="drop-zone rounded-xl flex items-center justify-center bg-white shadow-md text-gray-500">éŸ»æ¯</div>
                        <div id="tone-drop-2" data-type="tone" data-char="2" class="drop-zone rounded-full flex items-center justify-center bg-white shadow-md text-gray-500">è²èª¿</div>
                    </div>

                </div>
            </div>

            <!-- é»é¸å…ƒä»¶å€å¡Š (æœƒå‹•æ…‹å¡«å……ï¼Œåˆ†ç‚ºä¸‰å€) -->
            <div id="click-options-container" class="bg-blue-100 p-4 sm:p-6 rounded-lg shadow-lg">
                <p class="text-xl sm:text-2xl font-bold text-blue-800 mb-3 text-center">é»æ“Šé¸æ“‡æ³¨éŸ³ç¬¦è™Ÿï¼ˆæ¯å€åƒ…é¡¯ç¤º 5 å€‹é¸é …ï¼‰ï¼š</p>
                
                <!-- è²æ¯é¸é …å€ -->
                <h3 class="text-lg font-bold text-gray-700 mt-4 mb-2 border-b">è²æ¯ (Initial)</h3>
                <div id="initial-options" class="flex flex-wrap justify-center gap-2 sm:gap-3 p-2">
                    <!-- è²æ¯é¸é …å°‡åœ¨æ­¤è™•æ¸²æŸ“ (æœ€å¤š 5 å€‹) -->
                </div>
                
                <!-- éŸ»æ¯é¸é …å€ -->
                <h3 class="text-lg font-bold text-gray-700 mt-4 mb-2 border-b">éŸ»æ¯ (Final)</h3>
                <div id="final-options" class="flex flex-wrap justify-center gap-2 sm:gap-3 p-2">
                    <!-- éŸ»æ¯é¸é …å°‡åœ¨æ­¤è™•æ¸²æŸ“ (æœ€å¤š 5 å€‹) -->
                </div>
                
                <!-- è²èª¿é¸é …å€ -->
                <h3 class="text-lg font-bold text-gray-700 mt-4 mb-2 border-b">è²èª¿ (Tone)</h3>
                <div id="tone-options" class="flex flex-wrap justify-center gap-2 sm:gap-3 p-2">
                    <!-- è²èª¿é¸é …å°‡åœ¨æ­¤è™•æ¸²æŸ“ (æœ€å¤š 5 å€‹) -->
                </div>
            </div>

            <!-- æç¤ºå€å¡Š (é¡¯ç¤ºæ‹¼å‡ºçš„å­—ï¼Œå¹«åŠ©å°ä¸€ç”Ÿç¢ºèª) -->
            <div class="mt-6 text-center">
                <p class="text-xl sm:text-2xl font-semibold text-gray-700">
                    ç›®å‰æ‹¼å‡ºçš„éŸ³ï¼š
                    <span id="pinyin-display" class="text-gray-400 text-4xl sm:text-5xl font-extrabold ml-2">
                        _ _ _
                    </span>
                </p>
                <button id="next-button" class="mt-4 px-6 py-3 bg-green-500 text-white text-xl font-bold rounded-full shadow-lg hover:bg-green-600 transition duration-300 transform hover:scale-105" disabled>
                    ä¸‹ä¸€é¡Œ (å®Œæˆå¾Œé»æ“Š)
                </button>
            </div>
        </div>

        <!-- çµæœå€å¡Š (éŠæˆ²çµæŸå¾Œé¡¯ç¤º) -->
        <div id="result-area" class="hidden text-center p-8 bg-green-50 border-4 border-green-500 rounded-xl shadow-2xl">
            <h2 class="text-5xl font-extrabold text-green-700 mb-6">æ™‚é–“åˆ°ï¼éŠæˆ²çµæŸï¼</h2>
            <p class="text-3xl font-bold text-gray-800 mb-4">
                æ‚¨çš„æœ€çµ‚å¾—åˆ†ï¼š<span id="final-score" class="text-red-600 text-6xl ml-3">0</span> é¡Œ
            </p>
            <p class="text-xl text-gray-600 mb-8">è¡¨ç¾å¾ˆæ£’ï¼ä¼‘æ¯ä¸€ä¸‹å†æŒ‘æˆ°ä¸€æ¬¡å§ï¼</p>
            <button onclick="window.location.reload()" class="px-8 py-4 bg-red-500 text-white text-2xl font-bold rounded-full shadow-xl hover:bg-red-600 transition duration-300 transform hover:scale-105">
                å†ç©ä¸€æ¬¡
            </button>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯/æ“ä½œæç¤º (è‡ªå®šç¾© modalï¼Œå–ä»£ alert) -->
        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center border-t-8 border-red-500">
                <p id="modal-message" class="text-xl font-semibold text-gray-700 mb-4">éŒ¯èª¤ï¼</p>
                <button onclick="document.getElementById('modal').classList.add('hidden'); document.getElementById('modal').classList.remove('flex');" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                    ç¢ºå®š
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- éŠæˆ²è³‡æ–™èˆ‡è¨­å®š ---
        const GAME_DURATION = 180; // 3åˆ†é˜ = 180ç§’
        let timeLeft = GAME_DURATION;
        let timerInterval;
        let score = 0;
        let currentQuestionIndex = 0;
        
        // çµ±ä¸€çš„æ³¨éŸ³ç¬¦è™Ÿæ‹¼è®€é¡Œç›®çµæ§‹ (èˆ‡å‰ä¸€ç‰ˆæœ¬ç›¸åŒ)
        const QUESTIONS = [
            // å–®å­—
            { id: 1, chinese: 'å·´', sound: 'ã„…ã„šË‰', pinyin: [{ i: 'ã„…', f: 'ã„š', t: 'Ë‰' }] },
            { id: 2, chinese: 'å¡', sound: 'ã„†ã„›Ë‰', pinyin: [{ i: 'ã„†', f: 'ã„›', t: 'Ë‰' }] },
            { id: 3, chinese: 'ç±³', sound: 'ã„‡ã„§Ë‡', pinyin: [{ i: 'ã„‡', f: 'ã„§', t: 'Ë‡' }] },
            { id: 4, chinese: 'çˆ¶', sound: 'ã„ˆã„¨Ë‹', pinyin: [{ i: 'ã„ˆ', f: 'ã„¨', t: 'Ë‹' }] },
            { id: 5, chinese: 'çš„', sound: 'ã„‰ã„œË™', pinyin: [{ i: 'ã„‰', f: 'ã„œ', t: 'Ë™' }] },
            { id: 6, chinese: 'å°', sound: 'ã„Šã„ËŠ', pinyin: [{ i: 'ã„Š', f: 'ã„', t: 'ËŠ' }] },
            { id: 7, chinese: 'æ¨“', sound: 'ã„Œã„¡ËŠ', pinyin: [{ i: 'ã„Œ', f: 'ã„¡', t: 'ËŠ' }] },
            { id: 8, chinese: 'è™Ÿ', sound: 'ã„ã„ Ë‹', pinyin: [{ i: 'ã„', f: 'ã„ ', t: 'Ë‹' }] },
            { id: 9, chinese: 'æ±º', sound: 'ã„ã„©ã„ËŠ', pinyin: [{ i: 'ã„', f: 'ã„©ã„', t: 'ËŠ' }] },
            { id: 10, chinese: 'ç‰†', sound: 'ã„‘ã„§ã„¤ËŠ', pinyin: [{ i: 'ã„‘', f: 'ã„§ã„¤', t: 'ËŠ' }] },
            { id: 11, chinese: 'æœ½', sound: 'ã„’ã„§ã„¡Ë‡', pinyin: [{ i: 'ã„’', f: 'ã„§ã„¡', t: 'Ë‡' }] },
            { id: 12, chinese: 'å¢œ', sound: 'ã„“ã„¨ã„ŸË‹', pinyin: [{ i: 'ã„“', f: 'ã„¨ã„Ÿ', t: 'Ë‹' }] },
            
            // é›™å­—è©
            { id: 13, chinese: 'è˜‹æœ', sound: 'ã„†ã„§ã„¥ËŠ ã„ã„¨ã„›Ë‡', pinyin: [{ i: 'ã„†', f: 'ã„§ã„¥', t: 'ËŠ' }, { i: 'ã„', f: 'ã„¨ã„›', t: 'Ë‡' }] },
            { id: 14, chinese: 'å­¸æ ¡', sound: 'ã„’ã„©ã„ËŠ ã„’ã„§ã„ Ë‹', pinyin: [{ i: 'ã„’', f: 'ã„©ã„', t: 'ËŠ' }, { i: 'ã„’', f: 'ã„§ã„ ', t: 'Ë‹' }] },
            { id: 15, chinese: 'é‰›ç­†', sound: 'ã„‘ã„§ã„¢Ë‰ ã„…ã„§Ë‡', pinyin: [{ i: 'ã„‘', f: 'ã„§ã„¢', t: 'Ë‰' }, { i: 'ã„…', f: 'ã„§', t: 'Ë‡' }] },
            { id: 16, chinese: 'é›»è…¦', sound: 'ã„‰ã„§ã„¢Ë‹ ã„‹ã„ Ë‡', pinyin: [{ i: 'ã„‰', f: 'ã„§ã„¢', t: 'Ë‹' }, { i: 'ã„‹', f: 'ã„ ', t: 'Ë‡' }] },
            { id: 17, chinese: 'è´è¶', sound: 'ã„ã„¨ËŠ ã„‰ã„§ã„ËŠ', pinyin: [{ i: 'ã„', f: 'ã„¨', t: 'ËŠ' }, { i: 'ã„‰', f: 'ã„§ã„', t: 'ËŠ' }] },
            { id: 18, chinese: 'å“å”·', sound: 'ã„Ë‰ ã„§ã„›Ë‰', pinyin: [{ i: '', f: 'ã„', t: 'Ë‰' }, { i: '', f: 'ã„§ã„›', t: 'Ë‰' }] },
            { id: 19, chinese: 'ç‰›å¥¶', sound: 'ã„‹ã„§ã„¡ËŠ ã„‹ã„Ë‡', pinyin: [{ i: 'ã„‹', f: 'ã„§ã„¡', t: 'ËŠ' }, { i: 'ã„‹', f: 'ã„', t: 'Ë‡' }] },
            { id: 20, chinese: 'èèŸ»', sound: 'ã„‡ã„šË‡ ã„§Ë‡', pinyin: [{ i: 'ã„‡', f: 'ã„š', t: 'Ë‡' }, { i: '', f: 'ã„§', t: 'Ë‡' }] },            { id: 21, chinese: 'ä¸Ÿæ‰', sound: 'ã„‰ã„§ã„¡ ã„‰ã„§ã„ Ë‹', pinyin: [{ i: 'ã„‰', f: 'ã„§ã„¡', t: '' }, { i: 'ã„‰', f: 'ã„§ã„ ', t: 'Ë‹' }] },
            { id: 22, chinese: 'å³æ‰‹', sound: 'ã„§ã„¡Ë‹ ã„•ã„¡Ë‡', pinyin: [{ i: '', f: 'ã„§ã„¡', t: 'Ë‹' }, { i: 'ã„•', f: 'ã„¡', t: 'Ë‡' }] },
            { id: 23, chinese: 'é–‹é–€', sound: 'ã„ã„Ë‰ ã„‡ã„£ËŠ', pinyin: [{ i: 'ã„', f: 'ã„', t: 'Ë‰' }, { i: 'ã„‡', f: 'ã„£', t: 'ËŠ' }] },
            { id: 24, chinese: 'å¤¢æƒ³', sound: 'ã„‡ã„¥Ë‹ ã„’ã„§ã„¤Ë‡', pinyin: [{ i: 'ã„‡', f: 'ã„¥', t: 'Ë‹' }, { i: 'ã„’', f: 'ã„§ã„¤', t: 'Ë‡' }] },
            { id: 25, chinese: 'ç²¾ç¥', sound: 'ã„ã„§ã„¥Ë‰ ã„•ã„£ËŠ', pinyin: [{ i: 'ã„', f: 'ã„§ã„¥', t: 'Ë‰' }, { i: 'ã„•', f: 'ã„£', t: 'ËŠ' }] },
            { id: 26, chinese: 'è¦ªå»', sound: 'ã„‘ã„§ã„£Ë‰ ã„¨ã„£Ë‡', pinyin: [{ i: 'ã„‘', f: 'ã„§ã„£', t: 'Ë‰' }, { i: '', f: 'ã„¨ã„£', t: 'Ë‡' }] },
            { id: 27, chinese: 'èº«é«”', sound: 'ã„•ã„£Ë‰ ã„Šã„§Ë‡', pinyin: [{ i: 'ã„•', f: 'ã„£', t: 'Ë‰' }, { i: 'ã„Š', f: 'ã„§', t: 'Ë‡' }] },
            { id: 28, chinese: 'åˆ†æ•¸', sound: 'ã„ˆã„£Ë‰ ã„•ã„¨Ë‹', pinyin: [{ i: 'ã„ˆ', f: 'ã„£', t: 'Ë‰' }, { i: 'ã„•', f: 'ã„¨', t: 'Ë‹' }] },
            { id: 29, chinese: 'ç”Ÿæ—¥', sound: 'ã„•ã„¥Ë‰ ã„–Ë‹', pinyin: [{ i: 'ã„•', f: 'ã„¥', t: 'Ë‰' }, { i: 'ã„–', f: '', t: 'Ë‹' }] },
            { id: 30, chinese: 'è²éŸ³', sound: 'ã„•ã„¥Ë‰ ã„§ã„£Ë‰', pinyin: [{ i: 'ã„•', f: 'ã„¥', t: 'Ë‰' }, { i: '', f: 'ã„§ã„£', t: 'Ë‰' }] },
            { id: 31, chinese: 'æ—©ä¸Š', sound: 'ã„—ã„ Ë‡ ã„•ã„¤Ë‹', pinyin: [{ i: 'ã„—', f: 'ã„ ', t: 'Ë‡' }, { i: 'ã„•', f: 'ã„¤', t: 'Ë‹' }] },
            { id: 32, chinese: 'éŸ³æ¨‚', sound: 'ã„§ã„£Ë‰ ã„©ã„Ë‹', pinyin: [{ i: '', f: 'ã„§ã„£', t: 'Ë‰' }, { i: '', f: 'ã„©ã„', t: 'Ë‹' }] },
            { id: 33, chinese: 'é­”æ³•', sound: 'ã„‡ã„›ËŠ ã„ˆã„šË‡', pinyin: [{ i: 'ã„‡', f: 'ã„›', t: 'ËŠ' }, { i: 'ã„ˆ', f: 'ã„š', t: 'Ë‡' }] },
            { id: 34, chinese: 'ç’°ç¹', sound: 'ã„ã„¨ã„¢ËŠ ã„–ã„ Ë‹', pinyin: [{ i: 'ã„', f: 'ã„¨ã„¢', t: 'ËŠ' }, { i: 'ã„–', f: 'ã„ ', t: 'Ë‹' }] },
            { id: 35, chinese: 'è€é·¹', sound: 'ã„Œã„ Ë‡ ã„§ã„¥Ë‰', pinyin: [{ i: 'ã„Œ', f: 'ã„ ', t: 'Ë‡' }, { i: '', f: 'ã„§ã„¥', t: 'Ë‰' }] },
            { id: 36, chinese: 'æé¾', sound: 'ã„ã„¨ã„¥Ë‡ ã„Œã„¨ã„¥ËŠ', pinyin: [{ i: 'ã„', f: 'ã„¨ã„¥', t: 'Ë‡' }, { i: 'ã„Œ', f: 'ã„¨ã„¥', t: 'ËŠ' }] },
            { id: 37, chinese: 'å†°æ£’', sound: 'ã„…ã„§ã„¥Ë‰ ã„…ã„¤Ë‹', pinyin: [{ i: 'ã„…', f: 'ã„§ã„¥', t: 'Ë‰' }, { i: 'ã„…', f: 'ã„¤', t: 'Ë‹' }] },
            { id: 38, chinese: 'æ¨¹æ ¹', sound: 'ã„•ã„¨Ë‹ ã„ã„£Ë‰', pinyin: [{ i: 'ã„•', f: 'ã„¨', t: 'Ë‹' }, { i: 'ã„', f: 'ã„£', t: 'Ë‰' }] },
            { id: 39, chinese: 'ç°å¡µ', sound: 'ã„ã„¨ã„ŸË‰ ã„”ã„£ËŠ', pinyin: [{ i: 'ã„', f: 'ã„¨ã„Ÿ', t: 'Ë‰' }, { i: 'ã„”', f: 'ã„£', t: 'ËŠ' }] },
            { id: 40, chinese: 'ç·Šå¼µ', sound: 'ã„ã„§ã„£Ë‡ ã„“ã„¤Ë‰', pinyin: [{ i: 'ã„', f: 'ã„§ã„£', t: 'Ë‡' }, { i: 'ã„“', f: 'ã„¤', t: 'Ë‰' }] },
            { id: 41, chinese: 'æ„›å¿ƒ', sound: 'ã„Ë‹ ã„’ã„§ã„£Ë‰', pinyin: [{ i: '', f: 'ã„', t: 'Ë‹' }, { i: 'ã„’', f: 'ã„§ã„£', t: 'Ë‰' }] },
            { id: 42, chinese: 'é³³æ¢¨', sound: 'ã„ˆã„¥Ë‹ ã„Œã„§ËŠ', pinyin: [{ i: 'ã„ˆ', f: 'ã„¥', t: 'Ë‹' }, { i: 'ã„Œ', f: 'ã„§', t: 'ËŠ' }] },
            { id: 43, chinese: 'æª¸æª¬', sound: 'ã„‹ã„§ã„¥ËŠ ã„‡ã„¥ËŠ', pinyin: [{ i: 'ã„‹', f: 'ã„§ã„¥', t: 'ËŠ' }, { i: 'ã„‡', f: 'ã„¥', t: 'ËŠ' }] },
            { id: 44, chinese: 'ç¢°æ’', sound: 'ã„†ã„¥Ë‹ ã„“ã„¨ã„¤Ë‹', pinyin: [{ i: 'ã„†', f: 'ã„¥', t: 'Ë‹' }, { i: 'ã„“', f: 'ã„¨ã„¤', t: 'Ë‹' }] },
            { id: 45, chinese: 'ç³–æœ', sound: 'ã„Šã„¤ËŠ ã„ã„¨ã„›Ë‡', pinyin: [{ i: 'ã„Š', f: 'ã„¤', t: 'ËŠ' }, { i: 'ã„', f: 'ã„¨ã„›', t: 'Ë‡' }] },
            { id: 46, chinese: 'å°å·', sound: 'ã„’ã„§ã„ Ë‡ ã„Šã„¡Ë‰', pinyin: [{ i: 'ã„’', f: 'ã„§ã„ ', t: 'Ë‡' }, { i: 'ã„Š', f: 'ã„¡', t: 'Ë‰' }] },
            { id: 47, chinese: 'éµå¡”', sound: 'ã„Šã„§ã„Ë‡ ã„Šã„šË‡', pinyin: [{ i: 'ã„Š', f: 'ã„§ã„', t: 'Ë‡' }, { i: 'ã„Š', f: 'ã„š', t: 'Ë‡' }] },
            { id: 48, chinese: 'çŒ´å­', sound: 'ã„ã„¡ËŠ Ë™ã„—', pinyin: [{ i: 'ã„', f: 'ã„¡', t: 'ËŠ' }, { i: 'ã„—', f: '', t: 'Ë™' }] },
            { id: 49, chinese: 'å°ç‹—', sound: 'ã„’ã„§ã„ Ë‡ ã„ã„¡Ë‡', pinyin: [{ i: 'ã„’', f: 'ã„§ã„ ', t: 'Ë‡' }, { i: 'ã„', f: 'ã„¡', t: 'Ë‡' }] },
            { id: 50, chinese: 'çˆºçˆº', sound: 'ã„§ã„ËŠ Ë™ã„§ã„', pinyin: [{ i: '', f: 'ã„§ã„', t: 'ËŠ' }, { i: '', f: 'ã„§ã„', t: 'Ë™' }] },
            { id: 51, chinese: 'é´å­', sound: 'ã„’ã„©ã„Ë‰ Ë™ã„—', pinyin: [{ i: 'ã„’', f: 'ã„©ã„', t: 'Ë‰' }, { i: 'ã„—', f: '', t: 'Ë™' }] },
            { id: 52, chinese: 'å·«å©†', sound: 'ã„¨Ë‰ ã„†ã„›ËŠ', pinyin: [{ i: '', f: 'ã„¨', t: 'Ë‰' }, { i: 'ã„†', f: 'ã„›', t: 'ËŠ' }] },
            { id: 53, chinese: 'ç»ç’ƒ', sound: 'ã„…ã„›Ë‰ ã„Œã„§ËŠ', pinyin: [{ i: 'ã„…', f: 'ã„›', t: 'Ë‰' }, { i: 'ã„Œ', f: 'ã„§', t: 'ËŠ' }] },
            { id: 54, chinese: 'æŠ¹å¸ƒ', sound: 'ã„‡ã„›Ë‡ ã„…ã„¨Ë‹', pinyin: [{ i: 'ã„‡', f: 'ã„›', t: 'Ë‡' }, { i: 'ã„…', f: 'ã„¨', t: 'Ë‹' }] },
            { id: 55, chinese: 'èš¯èš“', sound: 'ã„‘ã„§ã„¡Ë‰ ã„§ã„£Ë‡', pinyin: [{ i: 'ã„‘', f: 'ã„§ã„¡', t: 'Ë‰' }, { i: '', f: 'ã„§ã„£', t: 'Ë‡' }] },
            { id: 56, chinese: 'æœ‹å‹', sound: 'ã„†ã„¥ËŠ ã„§ã„¡Ë‡', pinyin: [{ i: 'ã„†', f: 'ã„¥', t: 'ËŠ' }, { i: '', f: 'ã„§ã„¡', t: 'Ë‡' }] },
            { id: 57, chinese: 'çœ¼ç›', sound: 'ã„§ã„¢Ë‡ ã„ã„§ã„¥Ë‰', pinyin: [{ i: '', f: 'ã„§ã„¢', t: 'Ë‡' }, { i: 'ã„', f: 'ã„§ã„¥', t: 'Ë‰' }] },
            { id: 58, chinese: 'éš±å½¢', sound: 'ã„§ã„£Ë‡ ã„’ã„§ã„¥ËŠ', pinyin: [{ i: '', f: 'ã„§ã„£', t: 'Ë‡' }, { i: 'ã„’', f: 'ã„§ã„¥', t: 'ËŠ' }] },
            { id: 59, chinese: 'è°æ˜', sound: 'ã„˜ã„¨ã„¥Ë‰ ã„‡ã„§ã„¥ËŠ', pinyin: [{ i: 'ã„˜', f: 'ã„¨ã„¥', t: 'Ë‰' }, { i: 'ã„‡', f: 'ã„§ã„¥', t: 'ËŠ' }] },
            { id: 60, chinese: 'è¶³çƒ', sound: 'ã„—ã„¨ËŠ ã„‘ã„§ã„¡ËŠ', pinyin: [{ i: 'ã„—', f: 'ã„¨', t: 'ËŠ' }, { i: 'ã„‘', f: 'ã„§ã„¡', t: 'ËŠ' }] },
            { id: 61, chinese: 'æ´—æ¾¡', sound: 'ã„’ã„§Ë‡ ã„—ã„ Ë‡', pinyin: [{ i: 'ã„’', f: 'ã„§', t: 'Ë‡' }, { i: 'ã„—', f: 'ã„ ', t: 'Ë‡' }] },
            { id: 62, chinese: 'è€è™', sound: 'ã„Œã„ Ë‡ ã„ã„¨Ë‡', pinyin: [{ i: 'ã„Œ', f: 'ã„ ', t: 'Ë‡' }, { i: 'ã„', f: 'ã„¨', t: 'Ë‡' }] },
            { id: 63, chinese: 'å‹‡æ•¢', sound: 'ã„©ã„¥Ë‡ ã„ã„¢Ë‡', pinyin: [{ i: '', f: 'ã„©ã„¥', t: 'Ë‡' }, { i: 'ã„', f: 'ã„¢', t: 'Ë‡' }] },
            { id: 64, chinese: 'åŸå ¡', sound: 'ã„”ã„¥ËŠ ã„…ã„ Ë‡', pinyin: [{ i: 'ã„”', f: 'ã„¥', t: 'ËŠ' }, { i: 'ã„…', f: 'ã„ ', t: 'Ë‡' }] },
            { id: 65, chinese: 'è­¦å¯Ÿ', sound: 'ã„ã„§ã„¥Ë‡ ã„”ã„šËŠ', pinyin: [{ i: 'ã„', f: 'ã„§ã„¥', t: 'Ë‡' }, { i: 'ã„”', f: 'ã„š', t: 'ËŠ' }] },
            { id: 66, chinese: 'æª¯ç‡ˆ', sound: 'ã„Šã„ËŠ ã„‰ã„¥Ë‰', pinyin: [{ i: 'ã„Š', f: 'ã„', t: 'ËŠ' }, { i: 'ã„‰', f: 'ã„¥', t: 'Ë‰' }] },
            { id: 67, chinese: 'éˆ´éº', sound: 'ã„Œã„§ã„¥ËŠ ã„‰ã„¤Ë‰', pinyin: [{ i: 'ã„Œ', f: 'ã„§ã„¥', t: 'ËŠ' }, { i: 'ã„‰', f: 'ã„¤', t: 'Ë‰' }] },
            { id: 68, chinese: 'ç‰½æ‰‹', sound: 'ã„‘ã„§ã„¢Ë‰ ã„•ã„¡Ë‡', pinyin: [{ i: 'ã„‘', f: 'ã„§ã„¢', t: 'Ë‰' }, { i: 'ã„•', f: 'ã„¡', t: 'Ë‡' }] },
        ];

        // å®Œæ•´çš„æ³¨éŸ³ç¬¦è™Ÿåº«
        const INITIAL_TILES = ['ã„…', 'ã„†', 'ã„‡', 'ã„ˆ', 'ã„‰', 'ã„Š', 'ã„‹', 'ã„Œ', 'ã„', 'ã„', 'ã„', 'ã„', 'ã„‘', 'ã„’', 'ã„“', 'ã„”', 'ã„•', 'ã„–', 'ã„—', 'ã„˜', 'ã„™'];
        const FINAL_TILES = ['ã„š', 'ã„›', 'ã„œ', 'ã„', 'ã„', 'ã„Ÿ', 'ã„ ', 'ã„¡', 'ã„¢', 'ã„£', 'ã„¤', 'ã„¥', 'ã„¦', 'ã„§', 'ã„¨', 'ã„©', 'ã„§ã„š', 'ã„§ã„', 'ã„§ã„ ', 'ã„§ã„¡', 'ã„§ã„¢', 'ã„§ã„£', 'ã„§ã„¤', 'ã„§ã„¥', 'ã„¨ã„š', 'ã„¨ã„›', 'ã„¨ã„', 'ã„¨ã„Ÿ', 'ã„¨ã„¢', 'ã„¨ã„£', 'ã„¨ã„¤', 'ã„¨ã„¥', 'ã„©ã„', 'ã„©ã„¢', 'ã„©ã„£', 'ã„©ã„¥']; 
        const TONE_TILES = ['Ë‰', 'ËŠ', 'Ë‡', 'Ë‹', 'Ë™'];

        const TILE_MAP = {
            'initial': INITIAL_TILES,
            'final': FINAL_TILES,
            'tone': TONE_TILES
        };
        const MAX_OPTIONS_COUNT = 5; // é™åˆ¶é¸é …æ•¸é‡ç‚º 5

      

        // --- DOM å…ƒç´ å¿«å– ---
        const timerEl = document.getElementById('timer');
        const scoreEl = document.getElementById('score');
        const gameAreaEl = document.getElementById('game-area');
        const resultAreaEl = document.getElementById('result-area');
        const initialOptionsEl = document.getElementById('initial-options');
        const finalOptionsEl = document.getElementById('final-options');
        const toneOptionsEl = document.getElementById('tone-options');
        const pinyinDisplayEl = document.getElementById('pinyin-display');
        const nextButtonEl = document.getElementById('next-button');
        const modalEl = document.getElementById('modal');
        const chineseHintEl = document.getElementById('chinese-hint');
        const speakButtonEl = document.getElementById('speak-button');
        const speakerIconEl = document.getElementById('speaker-icon');
        const loadingSpinnerEl = document.getElementById('loading-spinner');

        // å¿«å–æ”¾ç½®å€ DOM å…ƒç´ 
        const dropZones = [
            { i: document.getElementById('initial-drop-1'), f: document.getElementById('final-drop-1'), t: document.getElementById('tone-drop-1') },
            { i: document.getElementById('initial-drop-2'), f: document.getElementById('final-drop-2'), t: document.getElementById('tone-drop-2') }
        ];
        const pinyinGroup2El = document.getElementById('pinyin-group-2');
        const separatorEl = document.getElementById('separator');


        // --- å·¥å…·å‡½æ•¸ (TTS éŸ³è¨Šè™•ç†) ---
        function showModal(message) {
            document.getElementById('modal-message').textContent = message;
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        function pcmToWav(pcm16, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcm16.byteLength);
            const view = new DataView(buffer);
            const channelCount = 1;
            const byteRate = sampleRate * channelCount * 2;
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.byteLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, channelCount, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, channelCount * 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.byteLength, true);
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }
            return new Blob([view], { type: 'audio/wav' });
        }
        
        function speakQuestionSound(text) {
            speakButtonEl.disabled = true;
            speakerIconEl.classList.add('hidden');
            loadingSpinnerEl.classList.remove('hidden');

            const safeText = encodeURIComponent(text);
            const filename = `audios/${safeText}.mp3`;
            const audio = new Audio(filename);

            // ğŸ’¡ ä¿®æ­£é‚è¼¯ï¼šå…ˆå˜—è©¦æ’­æ”¾ï¼Œå¦‚æœå¤±æ•—ï¼ˆé€šå¸¸æ˜¯æœªè¼‰å…¥æˆ–æ’­æ”¾æ¬Šé™ï¼‰ï¼Œ
            // å‰‡ç›£è½ 'canplaythrough' äº‹ä»¶ï¼Œç¢ºä¿éŸ³è¨Šå·²å®Œæ•´è¼‰å…¥å¾Œå†æ’­æ”¾ã€‚

            function playAudio() {
                audio.play()
                .then(() => {
                    // æˆåŠŸæ’­æ”¾ï¼Œç›£è½çµæŸäº‹ä»¶
                    audio.onended = () => {
                        speakButtonEl.disabled = false;
                        speakerIconEl.classList.remove('hidden');
                        loadingSpinnerEl.classList.add('hidden');
                    };
                })
                .catch(err => {
                    // æ’­æ”¾å¤±æ•—ï¼Œå¯èƒ½æ˜¯å› ç‚ºç€è¦½å™¨é‚„æ²’è¼‰å…¥æˆ–æ¬Šé™å•é¡Œã€‚
                    // ç”±æ–¼é€™æ˜¯è‡ªå‹•æ’­æ”¾ï¼Œæˆ‘å€‘å°‡å˜—è©¦ç­‰å¾…è¼‰å…¥å®Œæˆã€‚
                    console.error("é¦–æ¬¡æ’­æ”¾å˜—è©¦å¤±æ•—ï¼Œç­‰å¾…è¼‰å…¥ä¸­...", err);
                    
                    // 1. æª¢æŸ¥æ˜¯å¦æ˜¯ç€è¦½å™¨æ¬Šé™å•é¡Œ (ä½†é€šå¸¸åªæœƒå¤±æ•—ä¸€æ¬¡)
                    if (err.name === "NotAllowedError" || err.name === "AbortError") {
                        // å¦‚æœæ˜¯æ¬Šé™å•é¡Œï¼Œå‰‡ç›´æ¥è§£é™¤æŒ‰éˆ•ç¦ç”¨ï¼Œè®“ä½¿ç”¨è€…é»æ“Š
                        speakButtonEl.disabled = false;
                        speakerIconEl.classList.remove('hidden');
                        loadingSpinnerEl.classList.add('hidden');
                        showModal("ç€è¦½å™¨å¯èƒ½é˜»æ“‹äº†è‡ªå‹•æ’­æ”¾ã€‚è«‹é»æ“Šå–‡å­åœ–ç¤ºæ’­æ”¾éŸ³æª”ã€‚");
                        return;
                    }

                    // 2. å¦‚æœä¸æ˜¯æ¬Šé™å•é¡Œï¼Œç›£è½è¼‰å…¥å®Œæˆäº‹ä»¶
                    if (audio.readyState < 4) { // æª¢æŸ¥æ˜¯å¦å°šæœªè¼‰å…¥å®Œæˆ (HAVE_ENOUGH_DATA)
                        audio.addEventListener('canplaythrough', () => {
                            console.log("éŸ³è¨Šè¼‰å…¥å®Œæˆï¼Œé‡æ–°å˜—è©¦æ’­æ”¾ã€‚");
                            playAudio(); // é‡æ–°å‘¼å«æ’­æ”¾
                        }, { once: true });
                    } else {
                        // è¼‰å…¥å·²å®Œæˆä½†æ’­æ”¾ä»å¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤
                        console.error("éŸ³è¨Šè¼‰å…¥å®Œæˆå¾Œæ’­æ”¾ä»å¤±æ•—:", err);
                        showModal("èªéŸ³ç„¡æ³•æ’­æ”¾ï¼Œè«‹æª¢æŸ¥æ˜¯å¦æœ‰å°æ‡‰éŸ³æª”æˆ–ç¶²è·¯é€£ç·šã€‚");
                        speakButtonEl.disabled = false;
                        speakerIconEl.classList.remove('hidden');
                        loadingSpinnerEl.classList.add('hidden');
                    }
                });
            }

            playAudio();
        }


        // --- éŠæˆ²é‚è¼¯ï¼šé»æ“Šæ¨¡å¼ (æ–°å¢å‹•æ…‹é¸é …ç”Ÿæˆ) ---

        /**
         * ç”¢ç”ŸåŒ…å«æ­£ç¢ºç­”æ¡ˆä¸”ç¸½æ•¸ç‚º MAX_OPTIONS_COUNT (5) çš„ä¸é‡è¤‡é¸é …ã€‚
         * @param {string} type - é¡å‹ (initial, final, tone)
         * @param {string[]} requiredValues - è©²é¡Œæ­£ç¢ºç­”æ¡ˆæ‰€éœ€çš„æ‰€æœ‰ç¬¦è™Ÿ
         * @returns {string[]} åŒ…å«æ­£ç¢ºç­”æ¡ˆçš„æœ€å¤š 5 å€‹é¸é …
         */
        function getLimitedOptions(type, requiredValues) {
            const allOptions = TILE_MAP[type];
            const optionSet = new Set(requiredValues); // 1. å…ˆåŠ å…¥æ‰€æœ‰æ­£ç¢ºç­”æ¡ˆ

            // 2. éš¨æ©ŸåŠ å…¥å…¶ä»–ä¸é‡è¤‡çš„é¸é …ï¼Œç›´åˆ°é”åˆ°æœ€å¤§é™åˆ¶æˆ–é¸é …ç”¨ç›¡
            let attempts = 0;
            const maxAttempts = allOptions.length * 2; // å®‰å…¨é™åˆ¶
            while (optionSet.size < MAX_OPTIONS_COUNT && optionSet.size < allOptions.length && attempts < maxAttempts) {
                const randomIndex = Math.floor(Math.random() * allOptions.length);
                const randomTile = allOptions[randomIndex];
                // ç¢ºä¿åŠ å…¥çš„ä¸æ˜¯å·²æœ‰çš„
                optionSet.add(randomTile);
                attempts++;
            }
            
            return Array.from(optionSet);
        }

        /**æ¸²æŸ“å‹•æ…‹ç”¢ç”Ÿçš„ 5 å€‹é¸é …**/
        function generateAndRenderOptions() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            
            // 1. æ”¶é›†è©²é¡Œæ‰€éœ€çš„æ­£ç¢ºæ³¨éŸ³ç¬¦è™Ÿ
            const requiredInitials = [];
            const requiredFinals = [];
            const requiredTones = [];

            currentQ.pinyin.forEach(p => {
                requiredInitials.push(p.i);
                requiredFinals.push(p.f);
                requiredTones.push(p.t);
            });

            // 2. ç”¢ç”ŸåŒ…å«æ­£ç¢ºç­”æ¡ˆçš„é™é‡é¸é …é›†
            const initialTilesLimited = getLimitedOptions('initial', requiredInitials);
            const finalTilesLimited = getLimitedOptions('final', requiredFinals);
            const toneTilesLimited = getLimitedOptions('tone', requiredTones);

            // æ¸…ç©ºæ‰€æœ‰é¸é …å€
            initialOptionsEl.innerHTML = '';
            finalOptionsEl.innerHTML = '';
            toneOptionsEl.innerHTML = '';

            const renderTiles = (container, tiles, type) => {
                shuffleArray(tiles); // æ‰“äº‚é¸é …é †åº
                tiles.forEach(value => {
                    const div = document.createElement('div');
                    div.textContent = value;
                    div.dataset.value = value;
                    div.dataset.type = type;
                    div.classList.add('click-tile', 'bg-white', 'text-gray-800', 'text-3xl', 'sm:text-4xl', 'font-bold', 'rounded-lg', 'shadow-md', 'p-3', 'sm:p-4', 'w-16', 'h-16', 'sm:w-20', 'sm:h-20', 'flex', 'items-center', 'justify-center', 'transform', 'hover:shadow-lg', 'border-blue-400');
                    
                    div.addEventListener('click', handleTileClick);
                    container.appendChild(div);
                });
            };

            // 3. æ¸²æŸ“æœ‰é™çš„é¸é …
            renderTiles(initialOptionsEl, initialTilesLimited, 'initial');
            renderTiles(finalOptionsEl, finalTilesLimited, 'final');
            renderTiles(toneOptionsEl, toneTilesLimited, 'tone');
        }

        /**æª¢æŸ¥æ‰€æœ‰æ‹¼è®€å€æ˜¯å¦éƒ½è¢«æ­£ç¢ºå¡«æ»¿@returns {boolean}**/
        function checkCompletion() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            let isComplete = true;

            for (let i = 0; i < currentQ.pinyin.length; i++) {
                const expected = currentQ.pinyin[i];
                const group = dropZones[i]; // group 0 is char 1, group 1 is char 2
                
                // æª¢æŸ¥æ˜¯å¦èˆ‡æœŸæœ›å€¼åŒ¹é…
                if (group.i.dataset.value !== expected.i ||
                    group.f.dataset.value !== expected.f ||
                    group.t.dataset.value !== expected.t) {
                    isComplete = false;
                    break;
                }
            }
            return isComplete;
        }

        /**æ›´æ–°ç›®å‰æ‹¼è®€å€çš„é¡¯ç¤º**/
        function updatePinyinDisplay() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            let pinyinText = [];
            
            for (let i = 0; i < currentQ.pinyin.length; i++) {
                const group = dropZones[i];
                const initial = group.i.dataset.value || '_';
                const final = group.f.dataset.value || '_';
                const tone = group.t.dataset.value || '_';
                
                pinyinText.push(`${initial}${final}${tone}`);
            }
            
            pinyinDisplayEl.textContent = pinyinText.join(' ');


            if (checkCompletion()) {
                pinyinDisplayEl.textContent = currentQ.sound;
                pinyinDisplayEl.classList.add('text-green-600');
                pinyinDisplayEl.classList.remove('text-gray-400');
                nextButtonEl.disabled = false;

                // ç‚ºæ­£ç¢ºå¡«å…¥çš„ drop zone æ·»åŠ æœ€çµ‚æ¨£å¼ (åƒ…è¦–è¦ºç¢ºèªï¼Œé»æ“Šå¯ç§»é™¤)
                document.querySelectorAll('.drop-zone').forEach(el => {
                    if(el.dataset.value) {
                         el.classList.add('completed-answer');
                         el.classList.remove('bg-white', 'text-gray-500');
                    }
                });

            } else {
                pinyinDisplayEl.classList.remove('text-green-600');
                pinyinDisplayEl.classList.add('text-gray-400');
                nextButtonEl.disabled = true;

                // ç§»é™¤å®Œæˆæ¨£å¼
                document.querySelectorAll('.drop-zone').forEach(el => {
                    el.classList.remove('completed-answer');
                });
            }
        }

        /**è™•ç†é»æ“Šé¸é …å€æ³¨éŸ³ç¬¦è™Ÿçš„äº‹ä»¶**/
        function handleTileClick(e) {
            const clickedTile = e.currentTarget;
            const value = clickedTile.dataset.value;
            const type = clickedTile.dataset.type;
            const currentQ = QUESTIONS[currentQuestionIndex];

            // ğŸ”¹ å®šç¾©é¡å‹æ˜ å°„ï¼Œå› ç‚º dropZones ä½¿ç”¨ i/f/tï¼Œè€Œ dataset ä½¿ç”¨ initial/final/tone
            const typeMap = { 'initial': 'i', 'final': 'f', 'tone': 't' };
            
            let targetDropZone = null;

            // ğŸ”¹ é‚è¼¯ï¼šéæ­·æ‰€æœ‰å¯èƒ½çš„æ‹¼éŸ³çµ„ (æœ€å¤šå…©çµ„)
            for (let i = 0; i < currentQ.pinyin.length; i++) {
                const expected = currentQ.pinyin[i]; // æœŸæœ›çš„æ­£ç¢ºç­”æ¡ˆ ({i: 'ã„‰', f: 'ã„§ã„¡', t: 'Ë‰'})
                const group = dropZones[i];
                
                // ç²å–ç•¶å‰çµ„ä¸­å°æ‡‰é¡å‹çš„æ”¾ç½®å€å…ƒç´ 
                const dropElKey = typeMap[type]; // 'i', 'f', or 't'
                const dropEl = group[dropElKey]; // å¯¦éš›çš„ DOM å…ƒç´  (initial-drop-1, final-drop-1, etc.)
                
                // æª¢æŸ¥æ¢ä»¶ï¼š
                // 1. æ”¾ç½®å€å¿…é ˆæ˜¯ç©ºçš„ (`!dropEl.dataset.value`)
                // 2. è©²æ”¾ç½®å€çš„ã€ŒæœŸæœ›ç­”æ¡ˆã€å¿…é ˆèˆ‡ç©å®¶é»æ“Šçš„ã€Œç¬¦è™Ÿå€¼ã€ç›¸ç­‰ (`expected[dropElKey] === value`)
                if (!dropEl.dataset.value && expected[dropElKey] === value) {
                    targetDropZone = dropEl;
                    break; // âœ… æ‰¾åˆ°è©²ç¬¦è™Ÿæ­£ç¢ºçš„æ­¸å±¬æ ¼ï¼Œå°±å¡«é€™è£¡
                }
            }

            // è‹¥éƒ½æ²’æ‰¾åˆ°ç›¸ç¬¦ä½ç½®
            if (!targetDropZone) {
                // å¦‚æœç©å®¶é»æ“Šäº†ç©ºçš„è²æ¯/éŸ»æ¯é¸é … ("")ï¼Œä½†è©²é¡Œä¸éœ€è¦
                if (value === "") { 
                    showModal(`æ‚¨é¸æ“‡äº†ã€Œç©ºã€ç¬¦è™Ÿï¼Œä½†æœ¬é¡Œä¸­æ‰€æœ‰å±¬æ–¼ã€Œ${type}ã€çš„ç©ºä½éƒ½ä¸éœ€è¦ç©ºå­—ä¸²ä¾†å¡«è£œï¼`);
                } else {
                    showModal(`æ‚¨é¸æ“‡çš„ç¬¦è™Ÿ (${value}) ä¸¦ä¸å±¬æ–¼æ­¤é¡Œç­”æ¡ˆçš„æ­£ç¢ºä½ç½®ï¼`);
                }
                return;
            }

            // ğŸ”¹ æˆåŠŸå¡«å…¥
            targetDropZone.textContent = value === "" ? "ï¼ˆç©ºï¼‰" : value; // å°ç©ºå­—ä¸²é¡¯ç¤ºæç¤º
            targetDropZone.dataset.value = value;
            
            // æ¨£å¼æ›´æ–°ï¼šä½¿ç”¨è—è‰²èƒŒæ™¯è¡¨ç¤ºå·²å¡«å…¥
            targetDropZone.classList.remove('bg-white', 'text-gray-500');
            targetDropZone.classList.add('text-white', 'bg-blue-500');

            // âš ï¸ é—œéµä¿®æ­£ï¼šé€™è£¡ä¸å†ç¦ç”¨é¸é …ï¼
            // ç§»é™¤åŸæœ‰çš„: clickedTile.classList.add('selected'); 
            // ç§»é™¤åŸæœ‰çš„: clickedTile.style.opacity = '0.3'; 
            // ç§»é™¤åŸæœ‰çš„: clickedTile.style.pointerEvents = 'none'; 
            
            updatePinyinDisplay();
        }        

        /**è™•ç†é»æ“Šå·²å¡«å…¥çš„æ”¾ç½®å€çš„äº‹ä»¶ (é‚„åŸ)**/
        function handleDropZoneClick(e) {
            const dropZone = e.currentTarget;
            const value = dropZone.dataset.value;
            const type = dropZone.dataset.type;

            if (!value) return; // å¦‚æœæ˜¯ç©ºçš„ï¼Œä¸åšä»»ä½•äº‹

            // 1. **ç§»é™¤**æ‰¾åˆ°ä¾†æºé¸é …å…ƒç´ ä¸¦é‡æ–°å•Ÿç”¨çš„é‚è¼¯ (å› ç‚ºé¸é …æœ¬èº«å°±æ²’æœ‰è¢«ç¦ç”¨)

            // 2. æ¸…ç©ºæ”¾ç½®å€
            dropZone.textContent = type === 'initial' ? 'è²æ¯' : (type === 'final' ? 'éŸ»æ¯' : 'è²èª¿');
            dropZone.dataset.value = '';
            dropZone.classList.remove('completed-answer', 'text-white', 'bg-blue-500');
            dropZone.classList.add('bg-white', 'text-gray-500');

            updatePinyinDisplay();
        }


        /**è¨­å®šæ”¾ç½®å€ç‚ºåˆå§‹ç‹€æ…‹ï¼Œä¸¦æ ¹æ“šé¡Œç›®é¡¯ç¤ºæ•¸é‡**/
        function resetDropZones() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            const isTwoChar = currentQ.pinyin.length === 2;

            pinyinGroup2El.classList.toggle('hidden', !isTwoChar);
            separatorEl.classList.toggle('hidden', !isTwoChar);

            // é‡è¨­æ‰€æœ‰æ”¾ç½®å€
            dropZones.forEach(group => {
                Object.values(group).forEach(el => {
                    // æ¢å¾©é è¨­æ–‡å­—
                    el.innerHTML = el.dataset.type === 'initial' ? 'è²æ¯' : (el.dataset.type === 'final' ? 'éŸ»æ¯' : 'è²èª¿');
                    // æ¢å¾©é è¨­æ¨£å¼
                    el.classList.remove('completed-answer', 'text-white', 'bg-blue-500');
                    el.classList.add('bg-white', 'text-gray-500');
                    el.dataset.value = ''; // æ¸…é™¤å·²æ”¾ç½®çš„å€¼
                });
            });
            
            // é‡æ–°æ¸²æŸ“é¸é …ï¼Œç¢ºä¿å®ƒå€‘éƒ½è™•æ–¼æœªé¸ä¸­ç‹€æ…‹
            generateAndRenderOptions();
        }
        
        /**æ›´æ–°åœ‹å­—æç¤ºçš„é¡¯ç¤º**/
        function updateQuestionDisplay() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            chineseHintEl.textContent = currentQ.chinese;
        }

        /**é–‹å§‹ä¸‹ä¸€é¡Œ**/
        function nextQuestion() {
            if (checkCompletion()) {
                score++;
                scoreEl.textContent = score;
            }

            if (currentQuestionIndex < QUESTIONS.length - 1) {
                currentQuestionIndex++;
            } else {
                shuffleArray(QUESTIONS); 
                currentQuestionIndex = 0;
                showModal("å¤ªæ£’äº†ï¼æ‚¨å·²å®Œæˆæ‰€æœ‰é¡Œç›®ï¼ç¾åœ¨å°‡é‡æ–°é–‹å§‹ä¸€è¼ªæŒ‘æˆ°ï¼Œç›´åˆ°æ™‚é–“çµæŸã€‚");
            }
            
            resetDropZones(); // é€™è£¡æœƒå‘¼å« generateAndRenderOptions
            updatePinyinDisplay();
            updateQuestionDisplay();
            nextButtonEl.disabled = true;
            // ğŸš€ æ–°å¢ï¼šè‡ªå‹•æ’­æ”¾ç•¶å‰é¡Œç›®çš„éŸ³æª”

            const currentQ = QUESTIONS[currentQuestionIndex];
            speakQuestionSound(currentQ.sound);
        }

        /**åˆå§‹åŒ–äº‹ä»¶ç›£è½**/
        function initListeners() {
            // æ”¾ç½®å€ç›£è½ï¼šé»æ“Šé‚„åŸ (åªéœ€è¦è¨­å®šä¸€æ¬¡)
            document.querySelectorAll('.drop-zone').forEach(el => {
                el.addEventListener('click', handleDropZoneClick);
            });
            
            nextButtonEl.addEventListener('click', nextQuestion);
            
            // TTS èªéŸ³æ’­æ”¾æŒ‰éˆ•äº‹ä»¶
            speakButtonEl.addEventListener('click', () => {
                const currentQ = QUESTIONS[currentQuestionIndex];
                speakQuestionSound(currentQ.sound);
            });
        }

        /**é–‹å§‹éŠæˆ²è¨ˆæ™‚å™¨**/
        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = formatTime(timeLeft);

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }, 1000);
        }

        /**éŠæˆ²çµæŸ**/
        function endGame() {
            clearInterval(timerInterval);
            gameAreaEl.classList.add('hidden');
            resultAreaEl.classList.remove('hidden');
            document.getElementById('final-score').textContent = score;
        }

        /**éŠæˆ²åˆå§‹åŒ–**/
        function initializeGame() {
            shuffleArray(QUESTIONS); // æ‰“äº‚é¡Œç›®é †åº
            currentQuestionIndex = 0;
            score = 0;
            timeLeft = GAME_DURATION;
            scoreEl.textContent = score;
            timerEl.textContent = formatTime(timeLeft);
            gameAreaEl.classList.remove('hidden');
            resultAreaEl.classList.add('hidden');

            // åˆå§‹é¡Œç›®è¨­å®šåŠé¸é …æ¸²æŸ“
            initListeners(); // åˆå§‹åŒ–äº‹ä»¶ç›£è½
            resetDropZones(); // é€™è£¡æœƒå‘¼å« generateAndRenderOptions
            updatePinyinDisplay();
            updateQuestionDisplay(); 
            
            startTimer();

            // ğŸš€ æ–°å¢ï¼šéŠæˆ²é–‹å§‹æ™‚ï¼Œè‡ªå‹•æ’­æ”¾ç¬¬ä¸€é¡Œçš„éŸ³æª”
            const currentQ = QUESTIONS[currentQuestionIndex];
            speakQuestionSound(currentQ.sound);
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œé–‹å§‹éŠæˆ²
        window.onload = initializeGame;

    </script>
</body>
</html>
