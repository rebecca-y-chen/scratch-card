<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨éŸ³ç¬¦è™Ÿæ‹¼è®€é»é¸éŠæˆ²</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨æ•™è‚²éƒ¨æ¨è–¦çš„å­—é«” (å¦‚: Inter)ï¼Œä¸¦å¢åŠ æ³¨éŸ³ç¬¦è™Ÿçš„è¾¨è­˜åº¦ */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* é»é¸å…ƒä»¶æ¨£å¼ */
        .click-tile {
            cursor: pointer;
            user-select: none;
            transition: transform 0.15s ease-out, background-color 0.15s ease-out, opacity 0.3s;
            border: 2px solid transparent;
        }
        .click-tile:hover {
            transform: scale(1.05);
            background-color: #fcd34d; /* æ·ºé»ƒè‰² */
        }
        .click-tile.selected {
            opacity: 0.3; /* é¸ä¸­å¾Œè®Šæ·¡ï¼Œè¡¨ç¤ºå·²è¢«ä½¿ç”¨ */
            pointer-events: none; /* ç¦ç”¨é»æ“Š */
        }
        /* æ”¾ç½®å€æ¨£å¼ */
        .drop-zone {
            border: 3px dashed #9ca3af; /* ç°è‰²è™›ç·š */
            transition: background-color 0.2s;
            cursor: pointer; /* é»æ“Šå¯ç§»é™¤ */
        }
        .drop-zone:hover:not(.completed-answer) {
            background-color: #fef3c7; /* æ·ºé»ƒè‰²æç¤ºå¯é»æ“Š */
        }
        .drop-zone.completed-answer {
            background-color: #3b82f6; /* è—è‰²èƒŒæ™¯ (å·²å¡«å…¥) */
            color: #ffffff;
            border-style: solid;
            border-color: #2563eb;
        }
        /* èª¿æ•´åœ‹å­—æç¤ºå­—é«”å¤§å°ä»¥å®¹ç´äºŒå­—è© */
        #chinese-hint {
            font-size: clamp(3rem, 10vw, 5rem); /* RWD å­—é«”å¤§å° */
        }
        /* Pinyin Group wrapper for consistent spacing */
        .pinyin-group {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem; /* Space between initial, final, tone */
        }
        /* èª¿æ•´æ”¾ç½®å€å¤§å° */
        .drop-zone[data-type="tone"] {
            width: 4rem; 
            height: 4rem; 
            font-size: 1.875rem; 
        }
        .drop-zone[data-type="initial"], 
        .drop-zone[data-type="final"] {
            width: 6rem; 
            height: 6rem; 
            font-size: 2.25rem; 
        }
        @media (min-width: 640px) {
            .drop-zone[data-type="tone"] {
                width: 5rem; 
                height: 5rem; 
                font-size: 3rem; 
            }
            .drop-zone[data-type="initial"], 
            .drop-zone[data-type="final"] {
                width: 8rem; 
                height: 8rem; 
                font-size: 3.75rem; 
            }
        }
    </style>
</head>

<body class="p-4 sm:p-8">

    <div id="game-container" class="w-full max-w-5xl bg-white shadow-2xl rounded-xl p-6 sm:p-10 border-4 border-yellow-400">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-center text-red-600 mb-6 tracking-wide">
            æ³¨éŸ³ç¬¦è™Ÿé»é¸æ‹¼è®€
        </h1>

        <!-- éŠæˆ²è³‡è¨Šï¼šè¨ˆæ™‚å™¨èˆ‡åˆ†æ•¸ -->
        <div class="flex justify-between items-center mb-8 border-b-2 pb-4">
            <div class="text-xl sm:text-2xl font-bold text-gray-700">
                è¨ˆæ™‚å™¨: <span id="timer" class="text-red-500 text-3xl sm:text-4xl ml-2">3:00</span>
            </div>
            <div class="text-xl sm:text-2xl font-bold text-gray-700">
                åˆ†æ•¸: <span id="score" class="text-blue-500 text-3xl sm:text-4xl ml-2">0</span>
            </div>
        </div>

        <!-- éŠæˆ²å€å¡Š -->
        <div id="game-area">
            <!-- é¡Œç›®å€å¡Š -->
            <div class="mb-8 text-center bg-yellow-100 p-4 rounded-lg shadow-inner">
                
                <!-- åœ‹å­—æç¤ºå€å¡Š + èªéŸ³æŒ‰éˆ• -->
                <div class="flex flex-col items-center justify-center mb-6">
                    <div id="chinese-hint" class="font-extrabold text-red-700 p-4 bg-white rounded-xl shadow-lg mb-4">
                        <!-- åœ‹å­—æœƒåœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                    <!-- èªéŸ³æ’­æ”¾æŒ‰éˆ• -->
                    <button id="speak-button" class="bg-red-500 text-white p-4 rounded-full shadow-xl hover:bg-red-600 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                        <!-- Speaker Icon -->
                        <svg id="speaker-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                        </svg>
                        <!-- Loading Spinner -->
                        <div id="loading-spinner" class="hidden h-6 w-6 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                    </button>
                    <p class="text-sm mt-2 text-red-500 font-semibold">ï¼ˆé»æ“Šä¸Šæ–¹æŒ‰éˆ•è½**ç›®æ¨™ç™¼éŸ³**ï¼‰</p>
                </div>
                
                <p class="text-2xl sm:text-3xl font-semibold text-gray-800 mb-3">é»æ“Šæ³¨éŸ³ç¬¦è™Ÿï¼Œå°‡å®ƒå¡«å…¥æ­£ç¢ºä½ç½®ï¼š</p>
                
                <!-- æ”¾ç½®å€å¡Š - å·²èª¿æ•´ç‚ºå…©çµ„ -->
                <div id="all-drop-zones" class="flex flex-wrap justify-center items-center">
                    
                    <!-- ç¬¬ 1 å€‹å­— Pinyin Group -->
                    <div class="pinyin-group" id="pinyin-group-1">
                        <div id="initial-drop-1" data-type="initial" data-char="1" class="drop-zone rounded-xl flex items-center justify-center bg-white shadow-md text-gray-500">è²æ¯</div>
                        <div id="final-drop-1" data-type="final" data-char="1" class="drop-zone rounded-xl flex items-center justify-center bg-white shadow-md text-gray-500">éŸ»æ¯</div>
                        <div id="tone-drop-1" data-type="tone" data-char="1" class="drop-zone rounded-full flex items-center justify-center bg-white shadow-md text-gray-500">è²èª¿</div>
                    </div>
                    
                    <!-- åˆ†éš”ç¬¦è™Ÿ (é›™å­—è©æ™‚é¡¯ç¤º) -->
                    <div id="separator" class="hidden text-5xl sm:text-6xl font-bold text-gray-500 mx-4 sm:mx-6 my-2">|</div> 

                    <!-- ç¬¬ 2 å€‹å­— Pinyin Group (é›™å­—è©æ™‚æ‰é¡¯ç¤º) -->
                    <div class="pinyin-group hidden" id="pinyin-group-2">
                        <div id="initial-drop-2" data-type="initial" data-char="2" class="drop-zone rounded-xl flex items-center justify-center bg-white shadow-md text-gray-500">è²æ¯</div>
                        <div id="final-drop-2" data-type="final" data-char="2" class="drop-zone rounded-xl flex items-center justify-center bg-white shadow-md text-gray-500">éŸ»æ¯</div>
                        <div id="tone-drop-2" data-type="tone" data-char="2" class="drop-zone rounded-full flex items-center justify-center bg-white shadow-md text-gray-500">è²èª¿</div>
                    </div>

                </div>
            </div>

            <!-- é»é¸å…ƒä»¶å€å¡Š (æœƒå‹•æ…‹å¡«å……ï¼Œåˆ†ç‚ºä¸‰å€) -->
            <div id="click-options-container" class="bg-blue-100 p-4 sm:p-6 rounded-lg shadow-lg">
                <p class="text-xl sm:text-2xl font-bold text-blue-800 mb-3 text-center">é»æ“Šé¸æ“‡æ³¨éŸ³ç¬¦è™Ÿï¼ˆæ¯å€åƒ…é¡¯ç¤º 5 å€‹é¸é …ï¼‰ï¼š</p>
                
                <!-- è²æ¯é¸é …å€ -->
                <h3 class="text-lg font-bold text-gray-700 mt-4 mb-2 border-b">è²æ¯ (Initial)</h3>
                <div id="initial-options" class="flex flex-wrap justify-center gap-2 sm:gap-3 p-2">
                    <!-- è²æ¯é¸é …å°‡åœ¨æ­¤è™•æ¸²æŸ“ (æœ€å¤š 5 å€‹) -->
                </div>
                
                <!-- éŸ»æ¯é¸é …å€ -->
                <h3 class="text-lg font-bold text-gray-700 mt-4 mb-2 border-b">éŸ»æ¯ (Final)</h3>
                <div id="final-options" class="flex flex-wrap justify-center gap-2 sm:gap-3 p-2">
                    <!-- éŸ»æ¯é¸é …å°‡åœ¨æ­¤è™•æ¸²æŸ“ (æœ€å¤š 5 å€‹) -->
                </div>
                
                <!-- è²èª¿é¸é …å€ -->
                <h3 class="text-lg font-bold text-gray-700 mt-4 mb-2 border-b">è²èª¿ (Tone)</h3>
                <div id="tone-options" class="flex flex-wrap justify-center gap-2 sm:gap-3 p-2">
                    <!-- è²èª¿é¸é …å°‡åœ¨æ­¤è™•æ¸²æŸ“ (æœ€å¤š 5 å€‹) -->
                </div>
            </div>

            <!-- æç¤ºå€å¡Š (é¡¯ç¤ºæ‹¼å‡ºçš„å­—ï¼Œå¹«åŠ©å°ä¸€ç”Ÿç¢ºèª) -->
            <div class="mt-6 text-center">
                <p class="text-xl sm:text-2xl font-semibold text-gray-700">
                    ç›®å‰æ‹¼å‡ºçš„éŸ³ï¼š
                    <span id="pinyin-display" class="text-gray-400 text-4xl sm:text-5xl font-extrabold ml-2">
                        _ _ _
                    </span>
                </p>
                <button id="next-button" class="mt-4 px-6 py-3 bg-green-500 text-white text-xl font-bold rounded-full shadow-lg hover:bg-green-600 transition duration-300 transform hover:scale-105" disabled>
                    ä¸‹ä¸€é¡Œ (å®Œæˆå¾Œå•Ÿç”¨)
                </button>
            </div>
        </div>

        <!-- çµæœå€å¡Š (éŠæˆ²çµæŸå¾Œé¡¯ç¤º) -->
        <div id="result-area" class="hidden text-center p-8 bg-green-50 border-4 border-green-500 rounded-xl shadow-2xl">
            <h2 class="text-5xl font-extrabold text-green-700 mb-6">æ™‚é–“åˆ°ï¼éŠæˆ²çµæŸï¼</h2>
            <p class="text-3xl font-bold text-gray-800 mb-4">
                æ‚¨çš„æœ€çµ‚å¾—åˆ†ï¼š<span id="final-score" class="text-red-600 text-6xl ml-3">0</span> é¡Œ
            </p>
            <p class="text-xl text-gray-600 mb-8">è¡¨ç¾å¾ˆæ£’ï¼ä¼‘æ¯ä¸€ä¸‹å†æŒ‘æˆ°ä¸€æ¬¡å§ï¼</p>
            <button onclick="window.location.reload()" class="px-8 py-4 bg-red-500 text-white text-2xl font-bold rounded-full shadow-xl hover:bg-red-600 transition duration-300 transform hover:scale-105">
                å†ç©ä¸€æ¬¡
            </button>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯/æ“ä½œæç¤º (è‡ªå®šç¾© modalï¼Œå–ä»£ alert) -->
        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center border-t-8 border-red-500">
                <p id="modal-message" class="text-xl font-semibold text-gray-700 mb-4">éŒ¯èª¤ï¼</p>
                <button onclick="document.getElementById('modal').classList.add('hidden'); document.getElementById('modal').classList.remove('flex');" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                    ç¢ºå®š
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- éŠæˆ²è³‡æ–™èˆ‡è¨­å®š ---
        const GAME_DURATION = 180; // 3åˆ†é˜ = 180ç§’
        let timeLeft = GAME_DURATION;
        let timerInterval;
        let score = 0;
        let currentQuestionIndex = 0;
        
        // çµ±ä¸€çš„æ³¨éŸ³ç¬¦è™Ÿæ‹¼è®€é¡Œç›®çµæ§‹ (èˆ‡å‰ä¸€ç‰ˆæœ¬ç›¸åŒ)
        const QUESTIONS = [
            // å–®å­—
            { id: 1, chinese: 'å·´', sound: 'ã„…ã„šË‰', pinyin: [{ i: 'ã„…', f: 'ã„š', t: 'Ë‰' }] },
            { id: 2, chinese: 'å¡', sound: 'ã„†ã„›Ë‰', pinyin: [{ i: 'ã„†', f: 'ã„›', t: 'Ë‰' }] },
            { id: 3, chinese: 'ç±³', sound: 'ã„‡ã„§Ë‡', pinyin: [{ i: 'ã„‡', f: 'ã„§', t: 'Ë‡' }] },
            { id: 4, chinese: 'çˆ¶', sound: 'ã„ˆã„¨Ë‹', pinyin: [{ i: 'ã„ˆ', f: 'ã„¨', t: 'Ë‹' }] },
            { id: 5, chinese: 'çš„', sound: 'ã„‰ã„œË™', pinyin: [{ i: 'ã„‰', f: 'ã„œ', t: 'Ë™' }] },
            { id: 6, chinese: 'å°', sound: 'ã„Šã„ËŠ', pinyin: [{ i: 'ã„Š', f: 'ã„', t: 'ËŠ' }] },
            { id: 7, chinese: 'æ¨“', sound: 'ã„Œã„¡ËŠ', pinyin: [{ i: 'ã„Œ', f: 'ã„¡', t: 'ËŠ' }] },
            { id: 8, chinese: 'è™Ÿ', sound: 'ã„ã„ Ë‹', pinyin: [{ i: 'ã„', f: 'ã„ ', t: 'Ë‹' }] },
            { id: 9, chinese: 'æ±º', sound: 'ã„ã„©ã„ËŠ', pinyin: [{ i: 'ã„', f: 'ã„©ã„', t: 'ËŠ' }] },
            { id: 10, chinese: 'ç‰†', sound: 'ã„‘ã„§ã„¤ËŠ', pinyin: [{ i: 'ã„‘', f: 'ã„§ã„¤', t: 'ËŠ' }] },
            { id: 11, chinese: 'æœ½', sound: 'ã„’ã„§ã„¡Ë‡', pinyin: [{ i: 'ã„’', f: 'ã„§ã„¡', t: 'Ë‡' }] },
            { id: 12, chinese: 'å¢œ', sound: 'ã„“ã„¨ã„ŸË‹', pinyin: [{ i: 'ã„“', f: 'ã„¨ã„Ÿ', t: 'Ë‹' }] },
            
            // é›™å­—è©
            { id: 13, chinese: 'è˜‹æœ', sound: 'ã„†ã„§ã„¥ËŠ ã„ã„¨ã„›Ë‡', pinyin: [{ i: 'ã„†', f: 'ã„§ã„¥', t: 'ËŠ' }, { i: 'ã„', f: 'ã„¨ã„›', t: 'Ë‡' }] },
            { id: 14, chinese: 'å­¸æ ¡', sound: 'ã„’ã„©ã„ËŠ ã„’ã„§ã„ Ë‹', pinyin: [{ i: 'ã„’', f: 'ã„©ã„', t: 'ËŠ' }, { i: 'ã„’', f: 'ã„§ã„ ', t: 'Ë‹' }] },
            { id: 15, chinese: 'é‰›ç­†', sound: 'ã„‘ã„§ã„¢Ë‰ ã„…ã„§Ë‡', pinyin: [{ i: 'ã„‘', f: 'ã„§ã„¢', t: 'Ë‰' }, { i: 'ã„…', f: 'ã„§', t: 'Ë‡' }] },
            { id: 16, chinese: 'é›»è…¦', sound: 'ã„‰ã„§ã„¢Ë‹ ã„‹ã„ Ë‡', pinyin: [{ i: 'ã„‰', f: 'ã„§ã„¢', t: 'Ë‹' }, { i: 'ã„‹', f: 'ã„ ', t: 'Ë‡' }] },
            { id: 17, chinese: 'è´è¶', sound: 'ã„ã„¨ËŠ ã„‰ã„§ã„ËŠ', pinyin: [{ i: 'ã„', f: 'ã„¨', t: 'ËŠ' }, { i: 'ã„‰', f: 'ã„§ã„', t: 'ËŠ' }] },
        ];

        // å®Œæ•´çš„æ³¨éŸ³ç¬¦è™Ÿåº«
        const INITIAL_TILES = ['ã„…', 'ã„†', 'ã„‡', 'ã„ˆ', 'ã„‰', 'ã„Š', 'ã„‹', 'ã„Œ', 'ã„', 'ã„', 'ã„', 'ã„', 'ã„‘', 'ã„’', 'ã„“', 'ã„”', 'ã„•', 'ã„–', 'ã„—', 'ã„˜', 'ã„™'];
        const FINAL_TILES = ['ã„š', 'ã„›', 'ã„œ', 'ã„', 'ã„', 'ã„Ÿ', 'ã„ ', 'ã„¡', 'ã„¢', 'ã„£', 'ã„¤', 'ã„¥', 'ã„¦', 'ã„§', 'ã„¨', 'ã„©', 'ã„§ã„š', 'ã„§ã„', 'ã„§ã„ ', 'ã„§ã„¡', 'ã„§ã„¢', 'ã„§ã„£', 'ã„§ã„¤', 'ã„§ã„¥', 'ã„¨ã„š', 'ã„¨ã„›', 'ã„¨ã„', 'ã„¨ã„Ÿ', 'ã„¨ã„¢', 'ã„¨ã„£', 'ã„¨ã„¤', 'ã„¨ã„¥', 'ã„©ã„', 'ã„©ã„¢', 'ã„©ã„£', 'ã„©ã„¥']; 
        const TONE_TILES = ['Ë‰', 'ËŠ', 'Ë‡', 'Ë‹', 'Ë™'];

        const TILE_MAP = {
            'initial': INITIAL_TILES,
            'final': FINAL_TILES,
            'tone': TONE_TILES
        };
        const MAX_OPTIONS_COUNT = 5; // é™åˆ¶é¸é …æ•¸é‡ç‚º 5

      

        // --- DOM å…ƒç´ å¿«å– ---
        const timerEl = document.getElementById('timer');
        const scoreEl = document.getElementById('score');
        const gameAreaEl = document.getElementById('game-area');
        const resultAreaEl = document.getElementById('result-area');
        const initialOptionsEl = document.getElementById('initial-options');
        const finalOptionsEl = document.getElementById('final-options');
        const toneOptionsEl = document.getElementById('tone-options');
        const pinyinDisplayEl = document.getElementById('pinyin-display');
        const nextButtonEl = document.getElementById('next-button');
        const modalEl = document.getElementById('modal');
        const chineseHintEl = document.getElementById('chinese-hint');
        const speakButtonEl = document.getElementById('speak-button');
        const speakerIconEl = document.getElementById('speaker-icon');
        const loadingSpinnerEl = document.getElementById('loading-spinner');

        // å¿«å–æ”¾ç½®å€ DOM å…ƒç´ 
        const dropZones = [
            { i: document.getElementById('initial-drop-1'), f: document.getElementById('final-drop-1'), t: document.getElementById('tone-drop-1') },
            { i: document.getElementById('initial-drop-2'), f: document.getElementById('final-drop-2'), t: document.getElementById('tone-drop-2') }
        ];
        const pinyinGroup2El = document.getElementById('pinyin-group-2');
        const separatorEl = document.getElementById('separator');


        // --- å·¥å…·å‡½æ•¸ (TTS éŸ³è¨Šè™•ç†) ---
        function showModal(message) {
            document.getElementById('modal-message').textContent = message;
            modalEl.classList.remove('hidden');
            modalEl.classList.add('flex');
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }
        
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }
        
        function pcmToWav(pcm16, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcm16.byteLength);
            const view = new DataView(buffer);
            const channelCount = 1;
            const byteRate = sampleRate * channelCount * 2;
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.byteLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, channelCount, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, channelCount * 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.byteLength, true);
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }
            return new Blob([view], { type: 'audio/wav' });
        }
        
        function speakQuestionSound(text) {
            speakButtonEl.disabled = true;
            speakerIconEl.classList.add('hidden');
            loadingSpinnerEl.classList.remove('hidden');

            // å°‡ç©ºç™½èˆ‡ç‰¹æ®Šç¬¦è™Ÿè½‰æˆåˆæ³•æª”åï¼ˆä¾‹å¦‚ï¼šã„ã„¨ËŠ ã„‰ã„§ã„ËŠ â†’ ã„ã„¨ËŠ_ã„‰ã„§ã„ËŠï¼‰
            const safeText = encodeURIComponent(text); // æœƒæŠŠç©ºæ ¼è®Šæˆ %20ï¼Œä¸­æ–‡è®Šæˆ %E9%...
            const filename = `audios/${safeText}.mp3`; //ğŸ”¹æŒ‡å®šå­è³‡æ–™å¤¾ audios
            const audio = new Audio(filename);

            audio.play()
            .then(() => {
                audio.onended = () => {
                speakButtonEl.disabled = false;
                speakerIconEl.classList.remove('hidden');
                loadingSpinnerEl.classList.add('hidden');
                };
            })
            .catch(err => {
                console.error("æ’­æ”¾éŸ³è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
                showModal("èªéŸ³ç„¡æ³•æ’­æ”¾ï¼Œè«‹æª¢æŸ¥æ˜¯å¦æœ‰å°æ‡‰éŸ³æª”");
                speakButtonEl.disabled = false;
                speakerIconEl.classList.remove('hidden');
                loadingSpinnerEl.classList.add('hidden');
            });
        }


        // --- éŠæˆ²é‚è¼¯ï¼šé»æ“Šæ¨¡å¼ (æ–°å¢å‹•æ…‹é¸é …ç”Ÿæˆ) ---

        /**
         * ç”¢ç”ŸåŒ…å«æ­£ç¢ºç­”æ¡ˆä¸”ç¸½æ•¸ç‚º MAX_OPTIONS_COUNT (5) çš„ä¸é‡è¤‡é¸é …ã€‚
         * @param {string} type - é¡å‹ (initial, final, tone)
         * @param {string[]} requiredValues - è©²é¡Œæ­£ç¢ºç­”æ¡ˆæ‰€éœ€çš„æ‰€æœ‰ç¬¦è™Ÿ
         * @returns {string[]} åŒ…å«æ­£ç¢ºç­”æ¡ˆçš„æœ€å¤š 5 å€‹é¸é …
         */
        function getLimitedOptions(type, requiredValues) {
            const allOptions = TILE_MAP[type];
            const optionSet = new Set(requiredValues); // 1. å…ˆåŠ å…¥æ‰€æœ‰æ­£ç¢ºç­”æ¡ˆ

            // 2. éš¨æ©ŸåŠ å…¥å…¶ä»–ä¸é‡è¤‡çš„é¸é …ï¼Œç›´åˆ°é”åˆ°æœ€å¤§é™åˆ¶æˆ–é¸é …ç”¨ç›¡
            let attempts = 0;
            const maxAttempts = allOptions.length * 2; // å®‰å…¨é™åˆ¶
            while (optionSet.size < MAX_OPTIONS_COUNT && optionSet.size < allOptions.length && attempts < maxAttempts) {
                const randomIndex = Math.floor(Math.random() * allOptions.length);
                const randomTile = allOptions[randomIndex];
                // ç¢ºä¿åŠ å…¥çš„ä¸æ˜¯å·²æœ‰çš„
                optionSet.add(randomTile);
                attempts++;
            }
            
            return Array.from(optionSet);
        }

        /**æ¸²æŸ“å‹•æ…‹ç”¢ç”Ÿçš„ 5 å€‹é¸é …**/
        function generateAndRenderOptions() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            
            // 1. æ”¶é›†è©²é¡Œæ‰€éœ€çš„æ­£ç¢ºæ³¨éŸ³ç¬¦è™Ÿ
            const requiredInitials = [];
            const requiredFinals = [];
            const requiredTones = [];

            currentQ.pinyin.forEach(p => {
                requiredInitials.push(p.i);
                requiredFinals.push(p.f);
                requiredTones.push(p.t);
            });

            // 2. ç”¢ç”ŸåŒ…å«æ­£ç¢ºç­”æ¡ˆçš„é™é‡é¸é …é›†
            const initialTilesLimited = getLimitedOptions('initial', requiredInitials);
            const finalTilesLimited = getLimitedOptions('final', requiredFinals);
            const toneTilesLimited = getLimitedOptions('tone', requiredTones);

            // æ¸…ç©ºæ‰€æœ‰é¸é …å€
            initialOptionsEl.innerHTML = '';
            finalOptionsEl.innerHTML = '';
            toneOptionsEl.innerHTML = '';

            const renderTiles = (container, tiles, type) => {
                shuffleArray(tiles); // æ‰“äº‚é¸é …é †åº
                tiles.forEach(value => {
                    const div = document.createElement('div');
                    div.textContent = value;
                    div.dataset.value = value;
                    div.dataset.type = type;
                    div.classList.add('click-tile', 'bg-white', 'text-gray-800', 'text-3xl', 'sm:text-4xl', 'font-bold', 'rounded-lg', 'shadow-md', 'p-3', 'sm:p-4', 'w-16', 'h-16', 'sm:w-20', 'sm:h-20', 'flex', 'items-center', 'justify-center', 'transform', 'hover:shadow-lg', 'border-blue-400');
                    
                    div.addEventListener('click', handleTileClick);
                    container.appendChild(div);
                });
            };

            // 3. æ¸²æŸ“æœ‰é™çš„é¸é …
            renderTiles(initialOptionsEl, initialTilesLimited, 'initial');
            renderTiles(finalOptionsEl, finalTilesLimited, 'final');
            renderTiles(toneOptionsEl, toneTilesLimited, 'tone');
        }

        /**æª¢æŸ¥æ‰€æœ‰æ‹¼è®€å€æ˜¯å¦éƒ½è¢«æ­£ç¢ºå¡«æ»¿@returns {boolean}**/
        function checkCompletion() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            let isComplete = true;

            for (let i = 0; i < currentQ.pinyin.length; i++) {
                const expected = currentQ.pinyin[i];
                const group = dropZones[i]; // group 0 is char 1, group 1 is char 2
                
                // æª¢æŸ¥æ˜¯å¦èˆ‡æœŸæœ›å€¼åŒ¹é…
                if (group.i.dataset.value !== expected.i ||
                    group.f.dataset.value !== expected.f ||
                    group.t.dataset.value !== expected.t) {
                    isComplete = false;
                    break;
                }
            }
            return isComplete;
        }

        /**æ›´æ–°ç›®å‰æ‹¼è®€å€çš„é¡¯ç¤º**/
        function updatePinyinDisplay() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            let pinyinText = [];
            
            for (let i = 0; i < currentQ.pinyin.length; i++) {
                const group = dropZones[i];
                const initial = group.i.dataset.value || '_';
                const final = group.f.dataset.value || '_';
                const tone = group.t.dataset.value || '_';
                
                pinyinText.push(`${initial}${final}${tone}`);
            }
            
            pinyinDisplayEl.textContent = pinyinText.join(' ');


            if (checkCompletion()) {
                pinyinDisplayEl.textContent = currentQ.sound;
                pinyinDisplayEl.classList.add('text-green-600');
                pinyinDisplayEl.classList.remove('text-gray-400');
                nextButtonEl.disabled = false;

                // ç‚ºæ­£ç¢ºå¡«å…¥çš„ drop zone æ·»åŠ æœ€çµ‚æ¨£å¼ (åƒ…è¦–è¦ºç¢ºèªï¼Œé»æ“Šå¯ç§»é™¤)
                document.querySelectorAll('.drop-zone').forEach(el => {
                    if(el.dataset.value) {
                         el.classList.add('completed-answer');
                         el.classList.remove('bg-white', 'text-gray-500');
                    }
                });

            } else {
                pinyinDisplayEl.classList.remove('text-green-600');
                pinyinDisplayEl.classList.add('text-gray-400');
                nextButtonEl.disabled = true;

                // ç§»é™¤å®Œæˆæ¨£å¼
                document.querySelectorAll('.drop-zone').forEach(el => {
                    el.classList.remove('completed-answer');
                });
            }
        }

        /**è™•ç†é»æ“Šé¸é …å€æ³¨éŸ³ç¬¦è™Ÿçš„äº‹ä»¶**/
        function handleTileClick(e) {
            const clickedTile = e.currentTarget;
            const value = clickedTile.dataset.value;
            const type = clickedTile.dataset.type;

            const currentQ = QUESTIONS[currentQuestionIndex];
            
            let targetDropZone = null;

            // å°‹æ‰¾ç¬¬ä¸€å€‹åŒ¹é…é¡å‹ä¸”ç‚ºç©ºçš„æ”¾ç½®å€
            for (let i = 0; i < currentQ.pinyin.length; i++) {
                const expectedPinyin = currentQ.pinyin[i];
                const group = dropZones[i]; // group 0 is char 1, group 1 is char 2
                let dropEl = null;
                let expectedValue = '';

                if (type === 'initial') {
                    dropEl = group.i;
                    expectedValue = expectedPinyin.i;
                } else if (type === 'final') {
                    dropEl = group.f;
                    expectedValue = expectedPinyin.f;
                } else if (type === 'tone') {
                    dropEl = group.t;
                    expectedValue = expectedPinyin.t;
                }

                // å¦‚æœæ‰¾åˆ°ç©ºçš„æ”¾ç½®å€
                if (dropEl && !dropEl.dataset.value) {
                    // æª¢æŸ¥æ­£ç¢ºæ€§ (ç¢ºä¿è©²ç¬¦è™Ÿæ˜¯é¡Œç›®é€™å€‹ä½ç½®æ‰€éœ€è¦çš„)
                    if (value === expectedValue) {
                        targetDropZone = dropEl;
                        break; // æ‰¾åˆ°ç¬¬ä¸€å€‹æ­£ç¢ºçš„ç©ºæ ¼ï¼Œç«‹å³åœæ­¢
                    } else {
                        // é›–ç„¶æ˜¯ç©ºçš„ï¼Œä½†æ˜¯å¡«éŒ¯äº†ï¼ (æ­¤ç¬¦è™Ÿæ˜¯éŒ¯èª¤çš„å¹²æ“¾é …)
                        showModal(`æ‚¨é¸æ“‡çš„ç¬¦è™Ÿ (${value}) ä¸¦ä¸å±¬æ–¼æ­¤é¡Œç­”æ¡ˆçš„ä¸€éƒ¨åˆ†ï¼è«‹å†è©¦ä¸€æ¬¡ã€‚`);
                        return;
                    }
                }
            }

            if (targetDropZone) {
                // æˆåŠŸå¡«å…¥
                targetDropZone.textContent = value;
                targetDropZone.dataset.value = value;
                targetDropZone.classList.remove('bg-white', 'text-gray-500');
                targetDropZone.classList.add('text-white', 'bg-blue-500');

                clickedTile.classList.add('animate-ping-once');
                setTimeout(() => clickedTile.classList.remove('animate-ping-once'), 300);

                updatePinyinDisplay();

            } else {
                // æ²’æœ‰ç©ºçš„æ­£ç¢ºä½ç½®
                showModal(`è©²é¡å‹çš„æ‰€æœ‰æ­£ç¢ºä½ç½®éƒ½å·²å¡«æ»¿ï¼å¦‚éœ€æ›´æ”¹ï¼Œè«‹é»æ“Šå·²å¡«å…¥çš„æ³¨éŸ³ç¬¦è™Ÿã€‚`);
            }
        }
        
        /**è™•ç†é»æ“Šå·²å¡«å…¥çš„æ”¾ç½®å€çš„äº‹ä»¶ (é‚„åŸ)**/
        function handleDropZoneClick(e) {
            const dropZone = e.currentTarget;
            const value = dropZone.dataset.value;
            const type = dropZone.dataset.type;

            if (!value) return; // å¦‚æœæ˜¯ç©ºçš„ï¼Œä¸åšä»»ä½•äº‹

            // 1. æ‰¾åˆ°ä¾†æºé¸é …å…ƒç´ ä¸¦é‡æ–°å•Ÿç”¨
            const optionsContainer = document.getElementById(`${type}-options`);
            // é€é value å’Œ type å°‹æ‰¾å°æ‡‰çš„é¸é …å…ƒç´ 
            const sourceTile = Array.from(optionsContainer.children).find(tile => 
                tile.dataset.value === value && tile.dataset.type === type
            );

            if (sourceTile) {
                sourceTile.classList.remove('selected');
                sourceTile.style.opacity = '1';
                sourceTile.style.pointerEvents = 'auto';
            }

            // 2. æ¸…ç©ºæ”¾ç½®å€
            dropZone.textContent = type === 'initial' ? 'è²æ¯' : (type === 'final' ? 'éŸ»æ¯' : 'è²èª¿');
            dropZone.dataset.value = '';
            dropZone.classList.remove('completed-answer', 'text-white', 'bg-blue-500');
            dropZone.classList.add('bg-white', 'text-gray-500');

            updatePinyinDisplay();
        }


        /**è¨­å®šæ”¾ç½®å€ç‚ºåˆå§‹ç‹€æ…‹ï¼Œä¸¦æ ¹æ“šé¡Œç›®é¡¯ç¤ºæ•¸é‡**/
        function resetDropZones() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            const isTwoChar = currentQ.pinyin.length === 2;

            pinyinGroup2El.classList.toggle('hidden', !isTwoChar);
            separatorEl.classList.toggle('hidden', !isTwoChar);

            // é‡è¨­æ‰€æœ‰æ”¾ç½®å€
            dropZones.forEach(group => {
                Object.values(group).forEach(el => {
                    // æ¢å¾©é è¨­æ–‡å­—
                    el.innerHTML = el.dataset.type === 'initial' ? 'è²æ¯' : (el.dataset.type === 'final' ? 'éŸ»æ¯' : 'è²èª¿');
                    // æ¢å¾©é è¨­æ¨£å¼
                    el.classList.remove('completed-answer', 'text-white', 'bg-blue-500');
                    el.classList.add('bg-white', 'text-gray-500');
                    el.dataset.value = ''; // æ¸…é™¤å·²æ”¾ç½®çš„å€¼
                });
            });
            
            // é‡æ–°æ¸²æŸ“é¸é …ï¼Œç¢ºä¿å®ƒå€‘éƒ½è™•æ–¼æœªé¸ä¸­ç‹€æ…‹
            generateAndRenderOptions();
        }
        
        /**æ›´æ–°åœ‹å­—æç¤ºçš„é¡¯ç¤º**/
        function updateQuestionDisplay() {
            const currentQ = QUESTIONS[currentQuestionIndex];
            chineseHintEl.textContent = currentQ.chinese;
        }

        /**é–‹å§‹ä¸‹ä¸€é¡Œ**/
        function nextQuestion() {
            if (checkCompletion()) {
                score++;
                scoreEl.textContent = score;
            }

            if (currentQuestionIndex < QUESTIONS.length - 1) {
                currentQuestionIndex++;
            } else {
                shuffleArray(QUESTIONS); 
                currentQuestionIndex = 0;
                showModal("å¤ªæ£’äº†ï¼æ‚¨å·²å®Œæˆæ‰€æœ‰é¡Œç›®ï¼ç¾åœ¨å°‡é‡æ–°é–‹å§‹ä¸€è¼ªæŒ‘æˆ°ï¼Œç›´åˆ°æ™‚é–“çµæŸã€‚");
            }
            
            resetDropZones(); // é€™è£¡æœƒå‘¼å« generateAndRenderOptions
            updatePinyinDisplay();
            updateQuestionDisplay();
            nextButtonEl.disabled = true;
        }

        /**åˆå§‹åŒ–äº‹ä»¶ç›£è½**/
        function initListeners() {
            // æ”¾ç½®å€ç›£è½ï¼šé»æ“Šé‚„åŸ (åªéœ€è¦è¨­å®šä¸€æ¬¡)
            document.querySelectorAll('.drop-zone').forEach(el => {
                el.addEventListener('click', handleDropZoneClick);
            });
            
            nextButtonEl.addEventListener('click', nextQuestion);
            
            // TTS èªéŸ³æ’­æ”¾æŒ‰éˆ•äº‹ä»¶
            speakButtonEl.addEventListener('click', () => {
                const currentQ = QUESTIONS[currentQuestionIndex];
                speakQuestionSound(currentQ.sound);
            });
        }

        /**é–‹å§‹éŠæˆ²è¨ˆæ™‚å™¨**/
        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = formatTime(timeLeft);

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame();
                }
            }, 1000);
        }

        /**éŠæˆ²çµæŸ**/
        function endGame() {
            clearInterval(timerInterval);
            gameAreaEl.classList.add('hidden');
            resultAreaEl.classList.remove('hidden');
            document.getElementById('final-score').textContent = score;
        }

        /**éŠæˆ²åˆå§‹åŒ–**/
        function initializeGame() {
            shuffleArray(QUESTIONS); // æ‰“äº‚é¡Œç›®é †åº
            currentQuestionIndex = 0;
            score = 0;
            timeLeft = GAME_DURATION;
            scoreEl.textContent = score;
            timerEl.textContent = formatTime(timeLeft);
            gameAreaEl.classList.remove('hidden');
            resultAreaEl.classList.add('hidden');

            // åˆå§‹é¡Œç›®è¨­å®šåŠé¸é …æ¸²æŸ“
            initListeners(); // åˆå§‹åŒ–äº‹ä»¶ç›£è½
            resetDropZones(); // é€™è£¡æœƒå‘¼å« generateAndRenderOptions
            updatePinyinDisplay();
            updateQuestionDisplay(); 
            
            startTimer();
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œé–‹å§‹éŠæˆ²
        window.onload = initializeGame;

    </script>
</body>
</html>
